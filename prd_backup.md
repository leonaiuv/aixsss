# 漫剧创作助手 PRD（最终版）

> 版本：v2.1-final | 更新日期：2024年12月
> 
> 本版本优化：完整创作流程设计、上下文工程策略、AI Agent架构、渐进式UI/UX
> 
> v2.1更新内容：
> - 补充多元化用户画像（3个）
> - 明确级联更新策略（needs_update状态处理）
> - 定义流式响应UI交互规格
> - 补充分镜拖拽交互细节
> - 添加防抖/并发控制策略
> - 完善LocalStorage版本迁移机制
> - 补充埋点与数据分析模块
> - 添加可访问性、国际化、离线模式说明
> - 明确AI内容质量问题处理机制
> - 统一术语，修正章节编号错误

---

## 1) 产品概述

| 项目 | 说明 |
|------|------|
| **产品名称** | 漫剧创作助手 (暂定) |
| **产品定位** | 面向AI漫剧/短剧创作者的**智能化创作引导系统**，集成上下文工程与AI Agent架构 |
| **核心价值** | 通过**渐进式引导**与**智能上下文管理**，将创意想法系统化地转化为高质量、连贯的AIGC提示词，确保整部作品的视觉一致性 |
| **目标用户** | 个人AI内容创作者、短视频/漫画脚本初学者、对AIGC叙事感兴趣的内容生产者 |
| **典型场景** | 用户有一个故事点子，通过本应用**逐层构建**（世界观→人物→剧本→剧集→分镜），最终生成可直接用于Midjourney/Stable Diffusion等平台的提示词集 |
| **设计理念** | 参考Claude Skills的**渐进式披露**原则和Anthropic的**上下文工程**策略 |

---

## 2) 目标与范围

### 2.1 MVP目标
- MVP在1-2个月内上线，核心功能为"分镜生成"
- 提供混合交互模式（表单+对话），引导用户完成从剧本到分镜提示词的转化
- 支持用户配置自己的AI API Key（DeepSeek, Kimi, Gemini, OpenAI兼容接口），应用本身不产生AI调用费用
- 生成结构清晰、可复制的提示词文本，方便用户直接用于下游创作
- **提供完整的项目管理闭环**（项目列表、创建、保存、恢复）

### 2.2 非目标/不做
- MVP不内置AI图像/视频生成功能
- 不提供团队协作功能
- 不提供复杂的版本历史管理
- 不开发原生移动端App（响应式Web优先）
- 不提供新手教程/Onboarding功能（但保留过程中的操作引导）

---

## 3) 用户与体验

### 3.1 目标用户画像

#### 画像1：独立创作者小林

| 属性 | 描述 |
|------|------|
| **背景** | 28岁，自媒体创作者，熟悉Midjourney、ComfyUI等AIGC工具 |
| **痛点** | 提示词编写耗时耗力，多张图风格不统一，人物外观在不同分镜中不一致 |
| **核心诉求** | 希望有工具系统化管理整部短剧的提示词，确保视觉连贯性 |
| **使用场景** | 业余时间制作AI短剧投稿到视频平台 |
| **技术水平** | 中等，能独立获取和配置API Key |

#### 画像2：专业编剧转型者阿娜

| 属性 | 描述 |
|------|------|
| **背景** | 35岁，传统影视编剧，希望进入AI短剧赛道 |
| **痛点** | 擅长叙事但不熟悉AIGC提示词写法，学习成本高 |
| **核心诉求** | 希望用自然语言描述剧本，由AI转换为专业提示词 |
| **使用场景** | 将已有剧本转化为AI短剧，快速验证创意 |
| **技术水平** | 较低，需要清晰的操作引导 |

#### 画像3：漫画作者小吴

| 属性 | 描述 |
|------|------|
| **背景** | 25岁，在线漫画平台签约作者，希望用AI提升产能 |
| **痛点** | 分镜草图制作耗时，需要快速生成参考图 |
| **核心诉求** | 希望根据分镜脚本快速生成视觉参考，节省草图时间 |
| **使用场景** | 将漫画分镜脚本转化为AI参考图，用于内容规划 |
| **技术水平** | 中等，习惯使用各类创作工具 |

### 3.2 完整创作流程设计

> **设计理念**：参考Claude Skills的“渐进式披露”原则，每个阶段只展示当前步骤所需的最小信息，随着创作深入逐步披露更多细节。

#### 创作层级结构（从宏观到微观）

```
╭───────────────────────────────────────────────────────────────────────────────╮
│                           完整创作流程                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  Layer 0        Layer 1        Layer 2        Layer 3        Layer 4      │
│  世界观构建  ───▶  人物设定   ───▶  剧本创作   ───▶  剧集划分   ───▶  分镜细化      │
│  (宏观设定)      (角色塑造)      (故事展开)      (结构划分)      (视觉生成)    │
│      │              │              │              │              │          │
│      ▼              ▼              ▼              ▼              ▼          │
│  • 时代背景      • 主角特征      • 故事大纲      • 剧集摘要      • 场景描述    │
│  • 世界观设定    • 角色关系      • 故事动机      • 场景列表      • 动作描述    │
│  • 视觉风格      • 外观描述      • 冒险历程      • 节奠规划      • 镜头提示词  │
│  • 基础设定      • 性格属性      • 兴味点        • 情绪节奠      • 画面元素    │
│                                                                            │
╰───────────────────────────────────────────────────────────────────────────────╯
```

#### 信息继承关系

| 层级 | 名称 | 依赖上层 | 为下层提供 |
|------|------|----------|------------|
| L0 | 世界观 | - | 时代背景、视觉风格、基础设定 |
| L1 | 人物 | 世界观设定 | 角色外观、性格、关系网络 |
| L2 | 剧本 | 世界观 + 人物 | 故事大纲、冒险历程 |
| L3 | 剧集 | 剧本结构 | 单集摘要、场景列表 |
| L4 | 分镜 | 剧集 + 人物 + 风格 | 场景/动作/提示词 |

#### 用户旅程（MVP简化版）

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  项目工作台  │ -> │  基础设定   │ -> │  分镜规划   │ -> │  分镜细化   │ -> │  整合输出   │
│ (首页入口)  │    │ 剧本+风格+主角 │    │  分镜列表   │    │ 场景/动作/镜头│    │  复制提示词  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

**旅程详解**：
1. **项目工作台**：查看/创建/管理项目，支持状态恢复
2. **基础设定**：输入剧本概要、视觉风格、主角描述（融合L0-L2层）
3. **分镜规划**：AI生成分镜列表，用户可增删改排序
4. **分镜细化**：逐个分镜生成场景→动作→提示词
5. **整合输出**：生成格式化提示词文档，一键复制
6. **自动保存**：全程自动保存，中途离开可恢复

### 3.3 交互方式与UX准则

#### 核心交互原则

| 准则 | 说明 |
|------|------|
| **混合交互模式** | 先通过表单快速收集结构化信息，再进入深度对话进行优化和细化 |
| **分步确认** | AI每生成一个步骤立即展示，提供“确认”、“重生成”、“行内编辑”选项，确认后才进入下一步 |
| **容错与引导** | 任何AI生成步骤都提供“重生成”按钮；关键操作有明确状态反馈（按钮变为“已复制”+Toast轻提示）|
| **行内编辑** | 用户在AI生成的内容上直接点击即可修改，修改后自动保存，所见即所得 |
| **状态同步** | 用户编辑确认后，后续AI生成必须基于最新确认内容，保证上下文连贯 |

#### 渐进式披露设计（Progressive Disclosure）

> **设计理念**：参考Claude Skills的渐进式披露原则，只展示当前步骤所需的最小信息，避免信息过载。

```
╭───────────────────────────────────────────────────────────────────────────╮
│                      渐进式披露层级                                  │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Level 1: 项目级视图                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │  • 工作台：只显示项目卡片（标题+风格+进度）                         │   │
│  │  • 不展示：分镜详情、提示词内容                                    │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  Level 2: 分镜列表视图                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │  • 展示：分镜概要列表（序号+标题+状态徽章）                        │   │
│  │  • 不展示：单个分镜的场景/动作/提示词详情                          │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  Level 3: 单分镜细化视图                                                │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │  • 展示：当前步骤的生成内容 + 操作按钮                            │   │
│  │  • 上下文摘要：前一分镜的简要回顾（保持连贯）                        │   │
│  │  • 不展示：其他分镜的详细内容                                      │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                         │
╰───────────────────────────────────────────────────────────────────────────╯
```

#### 状态可视化设计

**创作进度指示器**：

```
┌───────────────────────────────────────────────────────────────────────────┐
│                           创作进度                                   │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  基础设定         分镜规划         分镜 1/5         分镜 2/5   ...    │
│     ✔               ✔            ●              ○              ○        │
│  [已完成]         [已完成]       [进行中]         [待处理]                │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────    │
│  ██████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░    │
│                              45%                                        │
│                                                                         │
└───────────────────────────────────────────────────────────────────────────┘
```

**单分镜处理状态指示器**：

```
┌─────────────────────────────────────────────────────────────────┐
│                分镜 1：废料场相遇                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   场景描述        动作描述        镜头提示词                    │
│      ✔              ●              ○                            │
│   [已确认]        [当前步骤]       [待生成]                      │
│                                                                 │
│   ───────────────────────────────────────────────────────    │
│   ████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░    │
│                        步骤 2/3                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**状态徽章系统**：

| 状态 | 徽章 | 颜色 | 说明 |
|------|------|------|------|
| 待处理 | ○ | 灰色 | 尚未开始的步骤 |
| 进行中 | ● | 蓝色动画 | 当前正在处理的步骤 |
| 已完成 | ✔ | 绿色 | 用户已确认的步骤 |
| 需修改 | ⚠ | 橙色 | 上游修改导致需重新确认 |
| 错误 | ✗ | 红色 | 生成失败，需重试 |

### 3.4 UI布局方案

#### 整体布局
采用**向导与仪表盘混合布局**：
- **左侧**：固定的垂直步骤导航栏（1. 项目信息 2. 设定风格 3. 生成分镜…）
- **右侧主区域**：当前步骤的内容区（表单或对话界面）
- **顶部**：项目标题、返回工作台、API配置入口

#### 关键页面设计

**1. 项目工作台（首页）**
- 顶部：应用Logo、API配置入口
- 主区域：
  - "创建新项目"按钮（醒目位置）
  - 最近项目列表（卡片形式，显示项目名、风格、更新时间）
  - 每个项目卡片支持：打开、删除操作

**2. 分镜生成页**
- **顶部**：当前分镜序号和总览进度条
- **主区域上部**：当前步骤的生成结果（如"场景描述"），附带"编辑"、"确认"按钮
- **主区域下部**：对话区域，用户可针对当前步骤向AI发出细化指令
- **右侧边栏**：缩略图面板，展示已确认的所有分镜步骤的摘要

---

## 4) 功能需求

### 4.1 Must-Have (MVP核心)

#### M0: 项目工作台（首页）
- **用户故事**：作为创作者，我希望有一个项目管理入口，能够创建新项目、查看和管理我的历史项目。
- **功能点**：
  - 显示"创建新项目"按钮
  - 展示最近项目列表（基于LocalStorage）
  - 支持打开已有项目（恢复到上次离开的精确步骤）
  - 支持删除项目（带确认提示）
- **验收标准**：
  - 用户可从首页创建新项目并进入编辑流程
  - 用户可从列表打开历史项目，状态完整恢复
  - 删除操作有二次确认，删除后列表即时更新

#### M1: 用户API配置管理
- **用户故事**：作为创作者，我希望能够安全地配置我自己的AI服务商API Key，以便应用能代表我与AI交互。
- **流程**：用户点击设置图标 -> 弹出模态框 -> 选择供应商（DeepSeek/Kimi/Gemini/OpenAI兼容）-> 输入API Key和可选Base URL -> 可选"测试连接" -> 保存（前端加密存储）。
- **安全方案**：
  - API Key仅存储于前端（LocalStorage，使用crypto-js AES加密）
  - 调用时通过Next.js API Route作为CORS代理转发，**后端不接触、不存储Key**
  - 传输全程使用HTTPS
- **输入**：供应商、API Key、Base URL（可选）、Model名称
- **输出**：配置保存成功状态；测试连接结果（可选）
- **验收标准**：
  - 配置后，应用能使用该配置成功调用对应AI的Chat Completion接口
  - 提供"测试连接"按钮验证API Key有效性

#### M2: 剧本输入与基础设定（表单阶段）
- **用户故事**：作为用户，我想先快速输入我的故事核心和视觉偏好，为后续AI引导设定基调。
- **流程**：在向导第一步，填写表单字段：剧本文本框、风格下拉框（如"赛博朋克"、"奇幻"等）、主角简短描述。
- **输入**：文本、选择项
- **输出**：结构化数据对象，作为后续所有AI调用的上下文
- **验收标准**：数据能正确传递到后续步骤，并持久化到LocalStorage

#### M3: 分步式分镜生成与引导（对话阶段）
- **用户故事**：作为用户，我希望AI能将我的剧本拆解成多个分镜，并逐步引导我为每个分镜完善场景、动作和镜头语言提示词。

**流程详解**：

**步骤1：生成分镜列表**
1. AI根据剧本，建议总的分镜数量及每个分镜的概要
2. 以可编辑卡片列表形式展示（如"分镜1：相遇"、"分镜2：冲突"）
3. 用户可对每个概要进行：
   - **编辑**：修改分镜概要描述
   - **删除**：移除某个分镜
   - **添加**：新增自定义分镜
   - **重排序**：拖拽调整顺序

**拖拽交互设计规格**：

| 场景 | 交互行为 | 说明 |
|------|----------|------|
| **拖拽开始** | 鼠标按住拖拽手柄（左侧∷图标），卡片渐变为半透明并略微抬起 | 视觉反馈明确 |
| **拖拽中** | 显示插入位置指示线（蓝色横线），其他卡片自动让开位置 | 清晰展示目标位置 |
| **拖拽释放** | 卡片平滑动画移动到新位置，自动重新编号 | 200ms过渡动画 |
| **拖拽取消** | 按Esc或拖出边界，卡片返回原位置 | 支持撤销 |

**移动端适配**：
- 暂不支持拖拽，使用“上移”/“下移”按钮代替
- 卡片操作菜单（…）中提供“移动到”选项
- MVP阶段框架端优先，移动端拖拽可延后实现

4. 用户点击“确认分镜列表”后，进入逐个分镜细化流程

**步骤2：逐个分镜细化（循环）**
对**每一个分镜**，依次执行：
- a. AI生成"场景描述" -> 用户确认/编辑/重生成
- b. AI基于场景生成"角色动作描述" -> 用户确认/编辑/重生成
- c. AI生成"镜头语言与提示词" -> 用户确认/编辑/重生成

**导航与回溯**：
- 用户可随时返回前序分镜重新调整
- 支持跳转到任意已完成的分镜查看/编辑

- **输入**：上一步的结构化数据、用户在每一步的确认或编辑后文本
- **输出**：一个包含N个分镜的数组，每个分镜对象包含`sceneDescription`, `actionDescription`, `shotPrompt`等字段
- **验收标准**：
  - 流程可走通，每个步骤的生成内容符合上下文
  - 用户编辑能实时反映在最终数据中
  - **后续步骤的AI生成必须使用用户确认后的最新内容**
  - 状态实时保存，刷新页面可恢复

#### M4: 最终提示词整合与复制
- **用户故事**：作为用户，当所有分镜完成后，我想一键复制整理好的、格式清晰的完整提示词，用于其他平台。
- **流程**：用户点击"生成最终提示词" -> 前端将所有分镜数据按预定模板（Markdown）拼接 -> 展示在只读文本框内 -> 提供"复制"按钮
- **默认模板示例**：
```markdown
# 项目：{projectTitle}
## 视觉风格：{style}

---

## 分镜 1：{sceneSummary}
### 场景描述
{sceneDescription}

### 角色动作
{actionDescription}

### 图像生成提示词
```
{shotPrompt}
```

---
（循环所有分镜）
```
- **输入**：所有分镜数据
- **输出**：格式化的文本字符串
- **验收标准**：点击复制后，文本能正确进入剪贴板，并有成功反馈（按钮状态变化+Toast）

### 4.2 Should-Have (MVP后优先)
- S1: 世界观构建模块（在分镜前增加一步）
- S2: 角色设定与管理模块
- S3: 导出为JSON或PDF文件
- S4: 自定义提示词模板

### 4.3 Could-Have (未来迭代)
- C1: 内置主流AIGC平台提示词风格模板
- C2: 分镜预览图生成（调用外部图像生成API）
- C3: 社区提示词模板分享

---

## 5) 实现与架构

### 5.1 整体架构

```
┌──────────────────────────────────────────────────────────────┐
│                        前端 (Next.js 15)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   UI组件    │  │  Zustand    │  │  LocalStorage       │  │
│  │ (Shadcn/ui) │  │  状态管理   │  │  (项目+配置持久化)   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                           │                                   │
│                           ▼                                   │
│  ┌───────────────────────────────────────────────────────┐   │
│  │              API Route (CORS代理层)                    │   │
│  │         后端不接触API Key，仅转发请求                   │   │
│  └───────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│                    AI服务提供商                               │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│   │ DeepSeek │  │   Kimi   │  │  Gemini  │  │ OpenAI兼容│    │
│   └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└──────────────────────────────────────────────────────────────┘
```

### 5.2 技术栈

| 层级 | 技术选型 | 理由 |
|------|----------|------|
| **前端框架** | Next.js 15 (App Router) + React 19 | 用户熟悉，支持Server Actions，部署简单 |
| **UI组件** | Shadcn/ui + Radix UI | 无障碍、可定制、现代化 |
| **状态管理** | Zustand | 轻量级，API简单，适合多步骤表单和分镜数据 |
| **持久化** | LocalStorage + crypto-js | MVP阶段无需数据库，加密存储API Key |
| **后端** | Next.js API Routes | 作为CORS代理，与前端统一技术栈 |
| **部署** | Vercel | 一键部署，自动HTTPS |

### 5.3 上下文工程策略（Context Engineering）

> **设计理念**：参考Anthropic的上下文工程最佳实践，LLM的注意力预算有限，随着上下文长度增加，模型精确回忆信息的能力会下降（Context Rot）。我们需要找到**最小可用的高信号Token集合**。

#### 5.3.1 核心原则

| 原则 | 说明 | 实现方式 |
|--------|------|------------|
| **渐进式披露** | 只在需要时才加载相关上下文 | 按层级按需加载，而非一次性加载所有数据 |
| **上下文压缩** | 将已确认的内容压缩为摘要 | 已完成分镜保留摘要而非全文 |
| **选择性注入** | 每步只注入当前任务所需的上下文 | 生成场景时不需要其他分镜的提示词 |
| **分层缓存** | 不同层级的信息独立缓存 | 世界观/人物一次加载，多次复用 |

#### 5.3.2 上下文窗口管理策略

```
╭──────────────────────────────────────────────────────────────────────╮
│                     Context Window 管理策略                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  System Prompt （固定层）                                      │   │
│  │  • 角色设定："你是专业的电影分镜师和AIGC提示词专家"                 │   │
│  │  • 任务约束：输出格式、长度限制、质量标准                          │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Project Context （项目层，压缩后注入）                          │   │
│  │  • 项目标题 + 视觉风格（简短）                                   │   │
│  │  • 主角核心特征（压缩为50字内）                                 │   │
│  │  • 故事核心冒险（压缩为100字内）                               │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Scene Context （分镜层，按需动态注入）                            │   │
│  │  • 当前分镜概要                                                  │   │
│  │  • 前一分镜摘要（保持连贯性）                                    │   │
│  │  • 已确认的上一步骤内容（如生成动作时注入场景描述）                 │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Task Instruction （任务层，当前步骤指令）                         │   │
│  │  • 具体任务描述（如"生成场景描述"）                              │   │
│  │  • 输出格式要求                                                  │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
╰──────────────────────────────────────────────────────────────────────╯
```

#### 5.3.3 各任务上下文组装规则

| 任务类型 | 注入的上下文 | 不注入的内容 |
|----------|--------------|----------------|
| **生成分镜列表** | 剧本概要、视觉风格、主角核心特征 | 其他项目数据 |
| **生成场景描述** | 当前分镜概要、风格、主角特征、前一分镜摘要 | 其他分镜详情 |
| **生成动作描述** | 当前场景描述(已确认)、主角特征、分镜概要 | 剧本全文、其他分镜 |
| **生成镜头提示词** | 场景+动作(已确认)、视觉风格 | 剧本全文、其他分镜 |
| **重新生成** | 原内容 + 用户修改意图 | 无关历史 |

#### 5.3.4 上下文压缩策略

> **压缩目标**：将完整内容压缩为简短摘要，减少Token消耗同时保留关键信息。

**MVP采用方案C：混合策略**

| 内容类型 | 压缩方式 | 说明 |
|----------|----------|------|
| 短内容（<100字） | 规则压缩（前端执行） | 直接截取前N字符，无额外成本 |
| 长内容（≥100字） | AI压缩 | 调用AI生成摘要，有额外Token消耗 |
| 项目核心信息 | 一次压缩多次复用 | 缓存到 `ProjectContextCache` |

```typescript
// 上下文压缩实现示例
interface ContextCompressor {
  // 将完整分镜压缩为摘要（用于序列中的上下文参考）
  compressScene(scene: Scene): SceneSummary;
  
  // 将项目信息压缩为核心要素
  compressProject(project: Project): ProjectEssence;
  
  // 生成前一分镜的过渡摘要
  generateTransitionSummary(prevScene: Scene): string;
}

// 规则压缩实现（前端执行，无额外成本）
function ruleBasedCompress(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  // 截取并添加省略号
  return text.slice(0, maxLength - 3) + '...';
}

// AI压缩实现（适用于长内容）
async function aiBasedCompress(
  text: string, 
  maxLength: number,
  aiGateway: AIGateway
): Promise<string> {
  const prompt = `请将以下内容压缩为${maxLength}字以内的摘要，保留核心信息：\n${text}`;
  return await aiGateway.generate(prompt, maxLength * 2);
}

interface SceneSummary {
  order: number;
  summary: string;        // 原概要，10-20字
  mood: string;           // 提取的情绪基调，5字内
  keyElement: string;     // 核心视觉元素，10字内
}

interface ProjectEssence {
  style: string;          // 原样保留
  protagonistCore: string; // 压缩为50字内的核心特征
  storyCore: string;       // 压缩为100字内的故事核心
}
```

### 5.4 AI Agent智能体架构

> **设计理念**：参考Claude Skills的架构，构建专业的AI Agent层统筹管理创作过程。Agent不是简单的API调用，而是“上下文构建 + 任务执行 + 结果处理”的完整闭环。

#### 5.4.1 Agent分层架构

```
╭──────────────────────────────────────────────────────────────────────╮
│                        AI Agent 架构                              │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Orchestration Layer （编排层）                                   │   │
│  │  • CreativeOrchestrator: 统筹整个创作流程                        │   │
│  │  • TaskScheduler: 任务调度与状态管理                             │   │
│  │  • ContextBuilder: 上下文构建与压缩                               │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  Skill Layer （技能层 - 类似Claude Skills）                        │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────────┐ │   │
│  │  │SceneListSkill│ │  SceneSkill  │ │ ActionSkill  │ │ PromptSkill │ │   │
│  │  │ 分镜列表生成  │ │  场景描述生成 │ │ 动作描述生成 │ │镜头提示词生成│ │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └─────────────┘ │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  AI Gateway Layer （AI网关层）                                     │   │
│  │  • PromptTemplateEngine: 提示词模板管理                           │   │
│  │  • AIAdapter: 多供应商适配（工厂模式）                             │   │
│  │  • ResponseParser: 响应解析与验证                                 │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                      │
╰──────────────────────────────────────────────────────────────────────╯
```

#### 5.4.2 Skill定义规范

> **设计说明**：每个Skill是一个专业化的提示词模板 + 上下文组装规则。Skill不是可执行代码，而是注入到会话中的专业化指令。

```typescript
// ==========================================
// Skill 定义规范
// ==========================================
// 设计理念：
// 1. 每个Skill封装一个特定创作任务的上下文组装和提示词模板
// 2. Skill之间可以组合使用，但每次只激活一个
// 3. Skill会修改会话上下文，而不是直接执行操作
// ==========================================

interface Skill {
  name: string;                    // 技能名称
  description: string;             // 何时触发此技能
  requiredContext: ContextType[];  // 所需上下文类型
  promptTemplate: string;          // 提示词模板
  outputFormat: OutputFormat;      // 输出格式约束
  maxTokens: number;               // 输出长度限制
}

// 示例：场景描述技能
const SceneSkill: Skill = {
  name: 'scene-description',
  description: '为单个分镜生成详细的场景描述',
  requiredContext: ['project_essence', 'current_scene_summary', 'prev_scene_summary'],
  promptTemplate: `
你是一位专业的电影分镜师。请为以下分镜生成详细的场景描述。

## 项目信息
视觉风格：{{style}}
主角特征：{{protagonistCore}}

## 当前分镜
分镜概要：{{currentSceneSummary}}
前一分镜：{{prevSceneSummary}}

## 输出要求
请描述：
1. 场景的空间环境（室内/室外、地点特征）
2. 光线和氛围
3. 关键道具或背景元素
4. 镜头构图建议

直接输出场景描述，200字以内。
  `,
  outputFormat: { type: 'text', maxLength: 200 },
  maxTokens: 500
};
```

#### 5.4.3 Agent执行流程

```
用户触发     Skill选择      上下文构建      AI调用       结果处理
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐    ┌───────┐
│用户点击 │───▶│根据当前 │───▶│从存储中 │───▶│调用AI  │───▶│解析响应 │
│"生成"  │    │状态选择 │    │加载所需 │    │Gateway│    │更新状态 │
│按钮    │    │对应Skill│    │上下文   │    │       │    │展示结果 │
└───────┘    └───────┘    └───────┘    └───────┘    └───────┘
                                   │
                                   ▼
                            ┌──────────────┐
                            │ 组装Prompt   │
                            │ • System     │
                            │ • Project    │
                            │ • Scene      │
                            │ • Task       │
                            └──────────────┘
```

#### 5.4.4 核心组件定义

```typescript
// CreativeOrchestrator - 创作流程编排器
class CreativeOrchestrator {
  private contextBuilder: ContextBuilder;
  private skillRegistry: Map<TaskType, Skill>;
  private aiGateway: AIGateway;

  // 执行生成任务
  async executeGeneration(task: GenerationTask): Promise<GenerationResult> {
    // 1. 选择对应的Skill
    const skill = this.skillRegistry.get(task.type);
    
    // 2. 构建上下文（按需加载，最小化Token消耗）
    const context = await this.contextBuilder.build(skill.requiredContext, task);
    
    // 3. 组装完整Prompt
    const prompt = this.assemblePrompt(skill.promptTemplate, context);
    
    // 4. 调用AI
    const response = await this.aiGateway.generate(prompt, skill.maxTokens);
    
    // 5. 解析并验证结果
    return this.parseAndValidate(response, skill.outputFormat);
  }
}

// ContextBuilder - 上下文构建器
class ContextBuilder {
  private projectStore: ProjectStore;
  private compressor: ContextCompressor;

  // 按需构建上下文，避免Context Rot
  async build(requiredTypes: ContextType[], task: GenerationTask): Promise<Context> {
    const context: Context = {};
    
    for (const type of requiredTypes) {
      switch (type) {
        case 'project_essence':
          // 加载压缩后的项目信息
          context.projectEssence = await this.compressor.compressProject(
            await this.projectStore.getProject(task.projectId)
          );
          break;
        case 'current_scene_summary':
          // 加载当前分镜概要
          context.currentScene = await this.projectStore.getScene(task.sceneId);
          break;
        case 'prev_scene_summary':
          // 加载前一分镜摘要（保持连贯性）
          context.prevSceneSummary = await this.getPrevSceneSummary(task);
          break;
        // ... 其他上下文类型
      }
    }
    
    return context;
  }
}
```

### 5.5 AI适配层架构（API工厂模式）

> **重要设计说明**：由于不同AI服务商的API格式、认证方式、响应结构存在差异，我们采用**API工厂模式**进行解耦。这不是过度设计，而是MVP必需的架构决策，确保后续扩展供应商时无需重构核心逻辑。

```typescript
// ==========================================
// AI适配层架构 - API工厂模式
// ==========================================
// 设计目的：
// 1. 解耦不同AI供应商的API差异（格式、认证、响应结构）
// 2. 统一上层调用接口，业务代码无需关心底层供应商
// 3. 便于后续扩展新的AI供应商
// 4. 集中处理错误码映射和流式响应
// ==========================================

// 统一接口定义
interface AIGateway {
  generateChatCompletion(
    messages: ChatMessage[],
    config: ProviderConfig
  ): Promise<AIResponse>;
  
  streamChatCompletion(
    messages: ChatMessage[],
    config: ProviderConfig
  ): AsyncGenerator<string>;
}

// 供应商适配器
class DeepSeekAdapter implements AIGateway { /* ... */ }
class KimiAdapter implements AIGateway { /* ... */ }
class GeminiAdapter implements AIGateway { /* ... */ }
class OpenAICompatibleAdapter implements AIGateway { /* ... */ }

// 工厂函数
function createAIAdapter(provider: ProviderType): AIGateway {
  switch (provider) {
    case 'deepseek': return new DeepSeekAdapter();
    case 'kimi': return new KimiAdapter();
    case 'gemini': return new GeminiAdapter();
    case 'openai-compatible': return new OpenAICompatibleAdapter();
    default: throw new Error(`Unsupported provider: ${provider}`);
  }
}
```

**各适配器职责**：
- 格式转换：将统一的Message格式转为供应商特定格式
- 认证处理：处理不同的API Key传递方式
- 错误码映射：将供应商错误码映射为统一的错误类型
- 流式响应：统一处理SSE/WebSocket等不同流式协议

### 5.6 安全策略

| 方面 | 策略 |
|------|------|
| **API Key存储** | 前端LocalStorage加密存储（AES），使用crypto-js |
| **API Key传输** | 前端解密后通过HTTPS发送到Next.js API Route，Route直接转发到AI供应商 |
| **后端职责** | 仅作为CORS代理，**不记录、不存储**用户的API Key |
| **输入清理** | 对用户输入进行基础清理，防止Prompt注入 |

---

## 6) 数据模型

### 6.1 核心实体

#### Project 项目
```typescript
interface Project {
  id: string;                    // UUID，主键
  title: string;                 // 项目名称
  
  // === 基础设定（L0-L2层融合） ===
  summary: string;               // 故事梗概
  style: string;                 // 视觉风格
  protagonist: string;           // 主角描述
  
  // === 上下文压缩缓存（用于AI调用） ===
  contextCache: ProjectContextCache;
  
  // === 工作流状态 ===
  workflowState: WorkflowState;  // 当前工作流状态
  currentSceneOrder: number;     // 当前处理的分镜序号
  currentSceneStep: SceneStep;   // 当前分镜的处理步骤
  
  // === 元数据 ===
  createdAt: string;             // 创建时间 ISO
  updatedAt: string;             // 更新时间 ISO
}

// 项目上下文缓存（用于每次AI调用的上下文注入）
interface ProjectContextCache {
  styleKeywords: string;         // 视觉风格关键词（20字内
  protagonistCore: string;       // 主角核心特征（50字内）
  storyCore: string;             // 故事核心（100字内）
  lastUpdated: string;           // 缓存更新时间
}

// 分镜处理步骤
type SceneStep = 
  | 'scene_description'   // 生成场景描述
  | 'action_description'  // 生成动作描述
  | 'shot_prompt';        // 生成镜头提示词
```

#### Scene 分镜
```typescript
interface Scene {
  id: string;              // UUID，主键
  projectId: string;       // 外键，关联Project.id
  order: number;           // 分镜序号
  
  // === 分镜内容 ===
  summary: string;             // 分镜概要（用于列表展示，10-20字）
  sceneDescription: string;    // 场景描述（用户确认后）
  actionDescription: string;   // 动作描述（用户确认后）
  shotPrompt: string;          // 镜头提示词（用户确认后）
  
  // === 上下文摘要（用于后续分镜参考） ===
  contextSummary: SceneContextSummary;
  
  // === 状态管理 ===
  status: SceneStatus;         // 分镜状态
  notes: string;               // 用户备注
}

// 分镜上下文摘要（自动生成，用于下一分镜的上下文注入）
interface SceneContextSummary {
  mood: string;            // 情绪基调，5字内
  keyElement: string;      // 核心视觉元素，15字内
  transition: string;      // 与下一分镜的过渡提示，20字内
}

// ✅ SceneContextSummary 生成时机与策略
// 1. 触发时机：用户确认分镜的“镜头提示词”后，自动调用AI生成摘要
// 2. 生成模式：后台异步生成，不阻塞用户进入下一分镜
// 3. 降级策略：生成失败时使用分镜的 summary 字段作为替代
// 4. 用户编辑：不支持用户手动编辑，但用户修改分镜内容后会自动重新生成

type SceneStatus = 
  | 'pending'              // 待处理
  | 'scene_generating'     // 场景生成中
  | 'scene_confirmed'      // 场景已确认
  | 'action_generating'    // 动作生成中
  | 'action_confirmed'     // 动作已确认
  | 'prompt_generating'    // 提示词生成中
  | 'completed'            // 全部完成
  | 'needs_update';        // 需更新（上游修改导致）
```

#### UserConfig 用户配置
```typescript
interface UserConfig {
  provider: 'deepseek' | 'kimi' | 'gemini' | 'openai-compatible';
  apiKey: string;        // 加密存储
  baseURL?: string;      // 可选，用于自定义端点
  model: string;         // 如 'deepseek-chat'
}
```

#### WorkflowState 工作流状态
```typescript
type WorkflowState =
  | 'IDLE'                    // 初始状态
  | 'DATA_COLLECTING'         // 基础信息填写中
  | 'DATA_COLLECTED'          // 基础信息已填写
  | 'SCENE_LIST_GENERATING'   // 分镜列表生成中
  | 'SCENE_LIST_EDITING'      // 分镜列表编辑中
  | 'SCENE_LIST_CONFIRMED'    // 分镜列表已确认
  | 'SCENE_PROCESSING'        // 分镜细化进行中
  | 'ALL_SCENES_COMPLETE'     // 全部完成
  | 'EXPORTING';              // 导出中
```

### 6.2 上下文管理模型

> 用于AI Agent层的上下文构建和压缩

```typescript
// 上下文类型枚举
type ContextType = 
  | 'project_essence'      // 项目核心信息（压缩后）
  | 'current_scene'        // 当前分镜完整信息
  | 'current_scene_summary' // 当前分镜概要
  | 'prev_scene_summary'   // 前一分镜摘要
  | 'confirmed_content'    // 已确认的当前步骤内容
  | 'scene_list_overview'; // 分镜列表概览

// 生成任务定义
interface GenerationTask {
  id: string;
  type: TaskType;
  projectId: string;
  sceneId?: string;
  sceneOrder?: number;
  retryCount: number;
  createdAt: string;
}

type TaskType = 
  | 'generate_scene_list'     // 生成分镜列表
  | 'generate_scene_desc'     // 生成场景描述
  | 'generate_action_desc'    // 生成动作描述
  | 'generate_shot_prompt'    // 生成镜头提示词
  | 'regenerate';             // 重新生成

// 生成结果
interface GenerationResult {
  success: boolean;
  content?: string;
  error?: string;
  tokenUsage?: {
    prompt: number;
    completion: number;
    total: number;
  };
}
```

### 6.3 关系
- 一个`Project`拥有多个`Scene` (1:N)
- 在`Scene.projectId`和`Scene.order`上创建复合索引

### 6.4 LocalStorage 存储结构
```typescript
interface LocalStorageSchema {
  'aixs_version': string;                 // 数据结构版本号，用于迁移判断
  'aixs_projects': Project[];             // 项目列表
  'aixs_scenes_{projectId}': Scene[];     // 各项目的分镜
  'aixs_config': UserConfig;              // 用户API配置（加密）
}
```

#### 版本迁移策略

> 数据结构升级时的兼容性处理。

```typescript
// 版本定义
const CURRENT_VERSION = '1.0.0';

// 迁移函数注册表
const migrations: Record<string, (data: unknown) => unknown> = {
  '0.9.0_to_1.0.0': (data) => {
    // 字段重命名、结构调整等
    return transformedData;
  },
};

// 启动时检查并执行迁移
function initStorage() {
  const storedVersion = localStorage.getItem('aixs_version') || '0.0.0';
  if (storedVersion !== CURRENT_VERSION) {
    runMigrations(storedVersion, CURRENT_VERSION);
    localStorage.setItem('aixs_version', CURRENT_VERSION);
  }
}
```

**损坏数据恢复**：
- 解析失败时提示“数据已损坏，是否清除并重新开始？”
- 备份损坏数据到 `aixs_backup` 以便后续恢复

### 6.5 示例数据
```json
{
  "project": {
    "id": "proj_123",
    "title": "机械之心",
    "summary": "在废土世界，一个机器人寻找人类心脏的故事。",
    "style": "赛博朋克废土",
    "protagonist": "机器人'铁皮'，锈迹斑斑的人形机器，眼睛发蓝光",
    "workflowState": "SCENE_PROCESSING",
    "currentSceneOrder": 1,
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-01T12:00:00Z"
  },
  "scenes": [
    {
      "id": "scene_1",
      "projectId": "proj_123",
      "order": 1,
      "summary": "废料场相遇",
      "sceneDescription": "广角镜头，展现一片荒芜的金属废料场，远处有巨大的废弃飞船残骸。天空是永恒的黄昏色。",
      "actionDescription": "主角机器人'铁皮'在废料中缓慢翻找，它的光学传感器闪烁着微弱的蓝光。",
      "shotPrompt": "wide shot, cyberpunk wasteland, scrap yard, giant derelict spaceship, eternal dusk sky, robot protagonist, cinematic lighting, --ar 16:9",
      "notes": "",
      "status": "completed"
    }
  ]
}
```

---

## 7) 接口与流程

### 7.1 API设计

#### POST /api/ai/chat
- **描述**：CORS代理，转发用户请求到AI服务商
- **请求体**：
```typescript
{
  messages: Array<{role: 'user' | 'assistant' | 'system', content: string}>;
  provider: ProviderType;
  apiKey: string;      // 前端解密后的明文Key
  baseURL?: string;
  model: string;
  stream?: boolean;    // 是否流式响应
}
```
- **响应**：AI服务商的原始响应或SSE流
- **安全**：API Route不记录、不存储apiKey

#### 流式响应UI交互规格

> 当 `stream: true` 时，需要定义流式输出UI行为。

| 场景 | UI行为 | 说明 |
|------|--------|------|
| **流式输出中** | 打字机效果逐字展示，底部显示闪烁光标 | 给用户即时反馈 |
| **用户中途取消** | 显示“停止生成”按钮，点击后终止流并保留已输出内容 | 可基于已生成内容编辑 |
| **网络中断** | 保留已接收内容，显示“网络中断，点击重试” | 用户可选择重试或编辑已有内容 |
| **生成完成** | 光标消失，显示“确认”和“重新生成”按钮 | 进入标准确认流程 |
| **超时处理** | 30秒无新内容则提示超时，保留已接收内容 | 同网络中断处理 |

**流式状态指示**：
```
┌──────────────────────────────────────────────────┐
│  场景描述                                           │
├──────────────────────────────────────────────────┤
│  广角镜头，展现一片荒芜的金属废料场，远处有  │
│  巨大的废弃飞船残骸。天空是永恒的黄昏色█         │
├──────────────────────────────────────────────────┤
│  ■ 生成中...                        [停止生成]  │
└──────────────────────────────────────────────────┘
```

### 7.2 工作流状态机

#### 主状态机（项目级）

```
╭─────────────────────────────────────────────────────────────────────────────╮
│                          项目工作流状态机                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────┐                                                                │
│  │  IDLE  │─────────────────────────────────────────────────────────╮   │
│  └───┬───┘                                                            │   │
│      │ 创建项目                                                          │   │
│      ▼                                                                  │   │
│  ┌────────────────┐                                                    │   │
│  │DATA_COLLECTING│ ←──────────────────────────────────────────────┘   │
│  └──────┬─────────┘                          返回修改基础设定              │
│        │ 确认基础设定                                                    │
│        ▼                                                                │
│  ┌──────────────┐   AI生成   ┌────────────────────┐                      │
│  │DATA_COLLECTED│ ───────▶ │SCENE_LIST_GENERATING│                      │
│  └──────────────┘            └─────────┬──────────┘                      │
│        ▲                           │ 生成完成                          │
│        │                           ▼                                   │
│        │                   ┌───────────────────┐                       │
│        │ 返回修改          │SCENE_LIST_EDITING │                       │
│        └───────────────────┤（用户增删改排序）│                       │
│                            └─────────┬─────────┘                       │
│                                      │ 确认分镜列表                     │
│                                      ▼                                  │
│                            ┌─────────────────────┐                     │
│                            │SCENE_LIST_CONFIRMED │                     │
│                            └──────────┬──────────┘                     │
│                                       │ 开始分镜细化                   │
│                                       ▼                                 │
│                            ┌─────────────────────┐                     │
│                            │  SCENE_PROCESSING   │────╮                │
│                            │ （循环处理每个分镜）  │    │ 全部完成       │
│                            └─────────────────────┘    │                │
│                                                   ▼                │
│                                       ┌─────────────────────┐      │
│                                       │ALL_SCENES_COMPLETE  │      │
│                                       └──────────┬──────────┘      │
│                                                  │ 导出             │
│                                                  ▼                  │
│                                       ┌─────────────────────┐      │
│                                       │     EXPORTING       │      │
│                                       └─────────────────────┘      │
│                                                                     │
╰─────────────────────────────────────────────────────────────────────────────╯
```

#### 子状态机（单分镜处理）

```
╭─────────────────────────────────────────────────────────────────────────────╮
│                          单分镜处理状态机                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐  开始  ┌─────────────────┐  完成  ┌───────────────┐           │
│  │ pending │ ───▶ │scene_generating │ ───▶ │scene_confirmed│           │
│  └─────────┘       └────────┬────────┘        └───────┬───────┘           │
│                          │ 失败                    │ 用户确认              │
│                          ▼                         ▼                        │
│                     [重试]               ┌──────────────────┐              │
│                                          │action_generating │              │
│                                          └────────┬─────────┘              │
│                                                  │ 完成                    │
│                                                  ▼                         │
│                                          ┌────────────────┐               │
│                                          │action_confirmed│               │
│                                          └────────┬───────┘               │
│                                                  │ 用户确认                │
│                                                  ▼                         │
│                                          ┌─────────────────┐              │
│                                          │prompt_generating │              │
│                                          └────────┬────────┘              │
│                                                  │ 完成                    │
│                                                  ▼                         │
│                                          ┌────────────────┐               │
│                                          │   completed    │               │
│                                          └────────────────┘               │
│                                                  │                         │
│                                                  ▼                         │
│                                           下一分镜 / 全部完成                │
│                                                                             │
╰─────────────────────────────────────────────────────────────────────────────╯
```

#### 状态转换规则

| 当前状态 | 触发事件 | 目标状态 | 副作用 |
|----------|----------|----------|----------|
| IDLE | 创建项目 | DATA_COLLECTING | 初始化项目数据 |
| DATA_COLLECTING | 确认基础设定 | DATA_COLLECTED | 缓存上下文 |
| DATA_COLLECTED | 开始生成分镜 | SCENE_LIST_GENERATING | 调用AI |
| SCENE_LIST_GENERATING | 生成完成 | SCENE_LIST_EDITING | 创建分镜对象 |
| SCENE_LIST_EDITING | 确认列表 | SCENE_LIST_CONFIRMED | 锁定列表 |
| SCENE_LIST_CONFIRMED | 开始细化 | SCENE_PROCESSING | 设置currentSceneOrder=1 |
| SCENE_PROCESSING | 当前分镜完成 | SCENE_PROCESSING | currentSceneOrder++ |
| SCENE_PROCESSING | 全部分镜完成 | ALL_SCENES_COMPLETE | - |
| ALL_SCENES_COMPLETE | 导出 | EXPORTING | 生成最终文档 |

#### 防抖/并发控制策略

> 防止用户快速连续操作导致的状态混乱和资源浪费。

| 场景 | 策略 | 实现方式 |
|------|--------|----------|
| **重复点击“生成”按钮** | 生成中禁用按钮，显示加载状态 | 按钮置为 `disabled`，防止重复提交 |
| **快速连续编辑** | 300ms防抖保存 | `debounce(saveState, 300)` |
| **AI请求进行中切换页面** | 弹窗确认“离开将取消当前生成” | 用户确认后取消请求，保存当前状态 |
| **多标签页同时编辑** | 检测冲突，提示“其他标签页已修改，是否加载最新？” | `BroadcastChannel` 跨标签页通信 |
| **状态保存失败** | 重试3次，失败后显示Toast警告 | 不阻塞用户操作，但提示风险 |

**状态持久化时机**：
- 状态变更后 300ms 防抖保存（避免频繁写入）
- 用户点击“确认”按钮时立即保存
- 页面 `beforeunload` 事件触发时强制保存

#### 上下文传递规则（关键设计）

> **重要**：用户确认/编辑后，后续AI生成**必须**使用用户确认后的最新内容。

| 生成任务 | 依赖的已确认内容 | 说明 |
|----------|----------------------|------|
| 生成动作描述 | 场景描述（用户确认版） | 确保动作与场景匹配 |
| 生成镜头提示词 | 场景+动作（用户确认版） | 确保提示词与前序内容一致 |
| 生成下一分镜场景 | 前一分镜摘要 | 保持叙事连贯性 |

#### 级联更新策略（needs_update状态处理）

> **场景**：用户修改前序分镜内容后，后续已生成内容如何处理？

**MVP采用方案B：警告但保留**

```
用户修改前序分镜 → 后续分镜标记为 needs_update → 用户手动决定是否重新生成
```

| 场景 | 系统行为 | 用户操作 |
|------|----------|----------|
| 用户修改分镜 N 的场景描述 | 分镜 N 的动作描述、提示词标记为 `needs_update` | 用户可选择“重新生成”或“保留原样” |
| 用户修改分镜 N 的动作描述 | 分镜 N 的提示词标记为 `needs_update` | 同上 |
| 用户删除分镜 N | 后续分镜序号重排，不影响内容 | 无需额外操作 |
| 用户调整分镜顺序 | 被移动分镜及其相邻分镜标记为 `needs_update` | 用户可选择性重新生成 |

**UI提示设计**：
- 标记为 `needs_update` 的内容显示橙色警告徽章 ⚠
- 悬浮提示：“上游内容已修改，建议重新生成以保持一致性”
- 提供“忽略警告”和“重新生成”两个按钮

### 7.3 提示词模板

#### 生成分镜列表
```
你是一位专业的电影分镜师。请根据以下故事梗概，将其拆解为{suggestedCount}个关键分镜。

故事梗概：{summary}
视觉风格：{style}

请为每个分镜提供一个简短的概要描述（10-20字），格式如下：
1. [分镜概要]
2. [分镜概要]
...

注意：分镜应该涵盖故事的起承转合，每个分镜是一个独立的画面或短序列。
```

#### 生成场景描述
```
你是一位专业的电影分镜师。请为以下分镜生成详细的场景描述。

分镜概要：{sceneSummary}
整体故事：{projectSummary}
视觉风格：{style}
主角设定：{protagonist}

请描述：
1. 场景的空间环境（室内/室外、地点特征）
2. 光线和氛围
3. 关键道具或背景元素
4. 镜头构图建议

输出格式：直接输出场景描述文本，200字以内。
```

#### 生成动作描述
```
你是一位专业的电影分镜师。请为以下场景生成角色动作描述。

场景描述：{sceneDescription}
主角设定：{protagonist}
分镜概要：{sceneSummary}

请描述角色在这个场景中的：
1. 主要动作和姿态
2. 表情和情绪
3. 与环境的互动

输出格式：直接输出动作描述文本，150字以内。
```

#### 生成镜头提示词
```
你是一位专业的AIGC提示词专家。根据以下场景和动作描述，生成一段高质量的图像生成提示词。

场景描述：{sceneDescription}
动作描述：{actionDescription}
视觉风格：{style}

要求：
1. 提示词需包含：构图、镜头类型、灯光、色彩基调、画质关键词
2. 格式紧凑，适用于Stable Diffusion或Midjourney
3. 使用英文输出
4. 末尾添加常用参数如 --ar 16:9

直接输出提示词，不要额外解释。
```

---

## 8) 异常处理与边界情况

### 8.1 异常流处理

| 异常场景 | 处理方式 |
|----------|----------|
| AI服务调用失败/超时 | 显示错误提示，提供"重试"按钮；超时设置30秒 |
| API Key无效 | 提示"API Key无效，请检查配置"，引导到设置页 |
| 用户输入内容为空 | 表单验证阻止提交，提示"请填写必要信息" |
| 分镜列表生成数量异常 | 限制范围1-20个，超出范围提示用户调整 |
| LocalStorage已满 | 提示用户删除旧项目，或导出数据 |
| 网络断开 | 检测离线状态，暂停AI调用，恢复后提示重试 |

### 8.2 AI内容质量问题处理

> 除技术异常外，还需处理AI生成内容本身的质量问题。

| 场景 | 处理方式 | 用户操作 |
|------|----------|----------|
| **输出格式不符合要求** | 自动重试1次，仍失败则提示用户手动编辑 | 可重新生成或手动输入 |
| **内容明显与上下文不符** | 显示警告“生成内容可能与上下文不一致，建议重新生成” | 提供“重新生成”和“继续使用”选项 |
| **内容过短或过长** | 自动截断超长内容，过短则提示重新生成 | 用户可编辑调整 |
| **包含敏感/不当内容** | 前端不做过滤，依赖AI服务商内置安全策略 | 用户负责终审 |
| **AI“幻觉”问题** | 无法自动检测，依赖用户审核 | 强调“用户确认”步骤的重要性 |

**人工干预入口**：
- 每个生成步骤都提供“编辑”按钮，支持用户完全重写
- 分镜列表支持手动添加分镜，不完全依赖AI

### 8.3 边界值限制

| 字段 | 限制 |
|------|------|
| 项目标题 | 1-50字符 |
| 故事梗概 | 10-5000字符 |
| 分镜数量 | 1-20个 |
| 单个分镜描述 | 最大2000字符 |
| 项目总数 | 最大50个（LocalStorage限制） |

---

## 9) 非功能需求

### 9.1 性能指标

| 指标 | 目标值 |
|------|--------|
| 首次内容绘制 (FCP) | < 1.5秒 |
| 表单输入响应 | < 100ms |
| 状态切换UI反馈 | < 200ms |
| AI响应超时 | 30秒 |
| 页面交互 | 无明显卡顿 |

### 9.2 安全与隐私
- 用户API Key前端加密存储（crypto-js AES）
- 全程HTTPS传输
- 明确隐私政策：不收集、不存储用户API Key
- 遵循所用AI服务商的API使用条款

### 9.3 兼容性
- 支持现代浏览器（Chrome 90+, Firefox 88+, Safari 14+, Edge 90+）
- 响应式设计，支持桌面端优先
- 目标覆盖99%页面可用性（基于Vercel SLA）

### 9.4 可访问性（A11y）

| 项目 | 要求 |
|------|------|
| **键盘导航** | Tab序列合理，所有交互元素可用键盘操作 |
| **屏幕阅读器** | 关键元素提供aria-label，状态变化有aria-live通知 |
| **对比度** | 文字对比度符合WCAG 2.1 AA标准 |
| **焦点指示** | 可见的focus状态指示器 |

### 9.5 国际化考量

- **MVP阶段**：中文优先，系统提示仅支持中文
- **预留i18n结构**：文本集中管理，不硬编码在组件中
- **AI提示词**：英文输出（因主流AIGC工具英文提示词效果更好）

### 9.6 离线模式

| 功能 | 离线支持 | 说明 |
|------|----------|------|
| 查看项目列表 | ✅ 支持 | 数据存储在LocalStorage |
| 查看分镜内容 | ✅ 支持 | 同上 |
| AI生成 | ❌ 不支持 | 显示“网络断开，无法生成” |
| 编辑已有内容 | ✅ 支持 | 编辑实时保存到LocalStorage |
| 复制提示词 | ✅ 支持 | 纯前端操作 |

### 9.7 埋点与数据分析

> MVP阶段需跟踪的核心指标，用于产品迭代决策。

#### 核心漏斗指标

```
创建项目 → 填写基础设定 → 生成分镜列表 → 完成首个分镜 → 完成全部分镜 → 复制提示词
  100%   →     ??%      →      ??%      →      ??%      →      ??%      →    ??%
```

#### 埋点事件

| 事件名 | 触发时机 | 关键属性 |
|--------|----------|----------|
| `project_created` | 创建新项目 | - |
| `settings_saved` | 确认基础设定 | `style`, `summary_length` |
| `scene_list_generated` | 分镜列表生成完成 | `scene_count`, `duration_ms` |
| `scene_list_confirmed` | 确认分镜列表 | `final_scene_count` |
| `scene_step_completed` | 单个分镜步骤完成 | `scene_order`, `step`, `was_edited` |
| `all_scenes_completed` | 全部分镜完成 | `total_scenes`, `total_duration_min` |
| `prompt_copied` | 复制提示词 | `format` |
| `ai_call_failed` | AI调用失败 | `error_type`, `provider` |
| `regenerate_clicked` | 点击重新生成 | `step`, `retry_count` |

#### 关键指标

| 指标 | 计算方式 | 目标值 |
|------|----------|--------|
| 项目完成率 | 完成全部分镜的项目数 / 创建项目数 | >30% |
| 平均分镜完成时间 | 从生成场景到确认提示词的时间 | <3min |
| AI调用成功率 | 成功AI调用次数 / 总AI调用次数 | >95% |
| 重新生成率 | 重新生成次数 / 总生成次数 | <20% |

---

## 10) 风险与缓解

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 不同AI供应商API差异大 | 高 | 高 | API工厂模式解耦，为每个供应商编写适配器 |
| 多步骤状态管理混乱 | 中 | 高 | Zustand严格定义状态结构，完善workflowState持久化 |
| 提示词生成质量不稳定 | 中 | 中 | 迭代优化系统提示词模板，未来可允许用户自定义 |
| LocalStorage容量限制 | 低 | 中 | 提供删除旧项目功能，未来版本支持导出/云存储 |
| 用户不熟悉API Key获取 | 中 | 低 | 配置页提供各供应商的获取链接说明 |

---

## 11) 迭代路线图

### 里程碑1：MVP上线（1-2个月）
- [ ] M0: 项目工作台
- [ ] M1: API配置管理
- [ ] M2: 剧本输入与基础设定
- [ ] M3: 分步式分镜生成
- [ ] M4: 提示词整合与复制
- [ ] 工作流状态持久化
- [ ] AI适配层（4个供应商）

### 里程碑2：体验完善（第3个月）
- [ ] S1: 世界观构建模块
- [ ] S2: 角色设定与管理
- [ ] UI/UX优化迭代
- [ ] 提示词模板优化

### 里程碑3：功能扩展（第4-5个月）
- [ ] S3: 导出JSON/PDF
- [ ] S4: 自定义提示词模板
- [ ] C1: AIGC平台风格模板
- [ ] C2: 分镜预览图生成（探索）

---

## 附录

### A. 技术栈版本
- Next.js: 15.x
- React: 19.x
- Zustand: 5.x
- Shadcn/ui: latest
- crypto-js: 4.x
- TypeScript: 5.x

### B. 假设条件
- 用户拥有并理解如何获取AI服务商的API Key
- 用户主要使用桌面端浏览器进行操作
- AI服务商的API稳定且可用
