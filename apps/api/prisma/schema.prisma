generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectWorkflowState {
  IDLE
  DATA_COLLECTING
  DATA_COLLECTED
  WORLD_VIEW_BUILDING
  CHARACTER_MANAGING
  EPISODE_PLANNING
  EPISODE_PLAN_EDITING
  EPISODE_CREATING
  SCENE_LIST_GENERATING
  SCENE_LIST_EDITING
  SCENE_LIST_CONFIRMED
  SCENE_PROCESSING
  ALL_SCENES_COMPLETE
  ALL_EPISODES_COMPLETE
  EXPORTING
}

enum EpisodeWorkflowState {
  IDLE
  CORE_EXPRESSION_READY
  SCENE_LIST_EDITING
  SCENE_PROCESSING
  COMPLETE
}

enum SceneStatus {
  pending
  scene_generating
  scene_confirmed
  keyframe_generating
  keyframe_confirmed
  motion_generating
  completed
  needs_update
}

enum ProviderType {
  deepseek
  kimi
  gemini
  openai_compatible
}

enum AIJobStatus {
  queued
  running
  succeeded
  failed
  cancelled
}

enum NarrativeCausalChainVersionSource {
  ai
  manual
  restore
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  memberships  TeamMember[]
  auditLogs    AuditLog[]
  narrativeCausalChainVersions NarrativeCausalChainVersion[]
}

model Team {
  id        String       @id @default(cuid())
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  members   TeamMember[]
  projects  Project[]
  aiProfiles AIProfile[]
  auditLogs AuditLog[]
  jobs      AIJob[]
  narrativeCausalChainVersions NarrativeCausalChainVersion[]
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      TeamRole @default(MEMBER)
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
}

model Project {
  id               String              @id @default(cuid())
  teamId           String
  title            String
  summary          String              @default("")
  style            String              @default("")
  artStyleConfig   Json?
  protagonist      String              @default("")
  contextCache     Json?
  workflowState    ProjectWorkflowState @default(DATA_COLLECTING)
  currentSceneOrder Int                @default(0)
  currentSceneStep  String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  deletedAt        DateTime?

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  narrativeCausalChainVersions NarrativeCausalChainVersion[]
  episodes Episode[]
  scenes Scene[]
  characters Character[]
  worldViewElements WorldViewElement[]
  jobs   AIJob[]

  @@index([teamId, updatedAt(sort: Desc)])
}

model NarrativeCausalChainVersion {
  id               String   @id @default(cuid())
  teamId           String
  projectId        String
  userId           String?
  source           NarrativeCausalChainVersionSource
  /** 触发该版本生成的阶段号（1-4，手动快照可为空） */
  phase            Int?
  /** 快照时的因果链完成阶段（0-4） */
  completedPhase   Int?
  /** 快照时的自洽校验状态：pass/needs_revision/incomplete */
  validationStatus String?
  /** 因果链 schema version（如 2.0.0） */
  chainSchemaVersion String?
  /** 用户可读标签（可空） */
  label            String?
  /** 备注（可空） */
  note             String?
  /** 若是恢复/派生，可指向来源版本 id（不做外键约束，便于软迁移） */
  basedOnVersionId String?
  /** 完整的叙事因果链 JSON */
  chain            Json
  createdAt        DateTime @default(now())

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId, createdAt(sort: Desc)])
  @@index([teamId, createdAt(sort: Desc)])
  @@index([userId])
}

model Episode {
  id             String              @id @default(cuid())
  projectId      String
  order          Int
  title          String              @default("")
  summary        String              @default("")
  outline        Json?
  coreExpression Json?
  contextCache   Json?
  workflowState  EpisodeWorkflowState @default(IDLE)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenes  Scene[]
  jobs    AIJob[]

  @@unique([projectId, order])
  @@index([projectId, order])
}

model Scene {
  id               String     @id @default(cuid())
  projectId        String
  episodeId        String
  order            Int
  summary          String     @default("")
  sceneDescription String     @default("")
  actionDescription String    @default("")
  shotPrompt       String     @default("")
  motionPrompt     String     @default("")
  dialogues        Json?
  contextSummary   Json?
  status           SceneStatus @default(pending)
  notes            String     @default("")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  jobs    AIJob[]

  @@unique([episodeId, order])
  @@index([episodeId, order])
  @@index([projectId, episodeId, order])
}

model Character {
  id               String   @id @default(cuid())
  projectId        String
  name             String
  briefDescription String?
  avatar           String?
  appearance       String   @default("")
  personality      String   @default("")
  background       String   @default("")
  portraitPrompts  Json?
  customStyle      String?
  relationships    Json?
  appearances      Json?
  themeColor       String?
  primaryColor     String?
  secondaryColor   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, updatedAt(sort: Desc)])
}

model WorldViewElement {
  id        String   @id @default(cuid())
  projectId String
  type      String
  title     String
  content   String   @default("")
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, order])
  @@index([projectId, order])
}

model AIProfile {
  id              String       @id @default(cuid())
  teamId          String
  name            String
  provider        ProviderType
  model           String
  baseURL         String?
  apiKeyEncrypted String
  generationParams Json?
  pricing         Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  jobs AIJob[]

  @@index([teamId, updatedAt(sort: Desc)])
}

model AuditLog {
  id         String   @id @default(cuid())
  teamId     String
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([teamId, createdAt(sort: Desc)])
  @@index([userId])
}

model AIJob {
  id        String     @id @default(cuid())
  teamId    String
  projectId String?
  episodeId String?
  sceneId   String?
  aiProfileId String?
  type      String
  status    AIJobStatus @default(queued)
  attempts  Int        @default(0)
  error     String?
  result    Json?
  createdAt DateTime   @default(now())
  startedAt DateTime?
  finishedAt DateTime?

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  episode Episode? @relation(fields: [episodeId], references: [id], onDelete: SetNull)
  scene   Scene?   @relation(fields: [sceneId], references: [id], onDelete: SetNull)
  aiProfile AIProfile? @relation(fields: [aiProfileId], references: [id], onDelete: SetNull)

  @@index([teamId, createdAt(sort: Desc)])
  @@index([status])
}

