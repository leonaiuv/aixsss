# 项目介绍与愿景

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [apps/web/README.md](file://apps/web/README.md)
- [apps/api/src/main.ts](file://apps/api/src/main.ts)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts)
- [apps/api/src/app.module.ts](file://apps/api/src/app.module.ts)
- [apps/web/src/App.tsx](file://apps/web/src/App.tsx)
- [apps/api/ENVIRONMENT.md](file://apps/api/ENVIRONMENT.md)
- [apps/worker/ENVIRONMENT.md](file://apps/worker/ENVIRONMENT.md)
- [apps/api/src/jobs/jobs.service.ts](file://apps/api/src/jobs/jobs.service.ts)
- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma)
- [apps/web/FINAL_REPORT.md](file://apps/web/FINAL_REPORT.md)
- [apps/web/IMPLEMENTATION_SUMMARY.md](file://apps/web/IMPLEMENTATION_SUMMARY.md)
- [apps/web/src/components/editor/SceneGeneration.tsx](file://apps/web/src/components/editor/SceneGeneration.tsx)
- [apps/web/src/stores/episodeStore.ts](file://apps/web/src/stores/episodeStore.ts)
- [apps/web/src/lib/workflowV2/index.ts](file://apps/web/src/lib/workflowV2/index.ts)
- [prd_backup.md](file://prd_backup.md)
</cite>

## 目录

1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言

AIXSSS（漫剧创作助手）是一个面向AIGC漫剧/短剧创作者的智能化创作引导系统。平台通过“前端分镜编辑与导出 + 后端鉴权与队列化AI工作流 + Worker执行AI任务”的三层架构，为创作者提供从基础设定到分镜细化再到多模态内容导出的完整创作闭环。平台的核心使命是降低AIGC内容创作门槛，提升创作效率与一致性，支持从个人创作者到团队协作的多样化场景。

平台的愿景是成为“可看源码、可扩展、可协作”的下一代叙事创作基础设施，持续推动AIGC在漫剧/短剧领域的规模化应用与标准化实践。

## 项目结构

项目采用monorepo结构，分为三个主要应用与共享包：

- apps/web：React + Vite前端应用，提供分镜编辑、工作流管理、导出与设置等功能
- apps/api：NestJS后端服务，负责鉴权、项目/分镜存储、AI作业队列与工作流编排
- apps/worker：基于BullMQ的任务执行器，承接后端队列中的AI任务并落地执行
- packages/shared：前后端共享的类型与Zod Schema，保障数据契约一致性

```mermaid
graph TB
subgraph "前端应用"
WEB["apps/web<br/>React/Vite"]
end
subgraph "后端服务"
API["apps/api<br/>NestJS"]
PRISMA["Prisma ORM<br/>PostgreSQL"]
REDIS["Redis<br/>BullMQ队列"]
end
subgraph "任务执行"
WORKER["apps/worker<br/>BullMQ Worker"]
end
subgraph "共享包"
SHARED["packages/shared<br/>类型与Schema"]
end
WEB --> API
API --> PRISMA
API --> REDIS
WORKER --> REDIS
WORKER --> PRISMA
API -.-> SHARED
WEB -.-> SHARED
```

**图表来源**

- [apps/api/src/main.ts](file://apps/api/src/main.ts#L9-L26)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L44-L729)
- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L1-L8)

**章节来源**

- [README.md](file://README.md#L63-L73)
- [apps/web/README.md](file://apps/web/README.md#L101-L135)

## 核心组件

- 前端编辑器（apps/web）
  - 提供项目管理、基础设定、分镜生成与细化、提示词导出、AI参数调优、版本管理、搜索与快捷键等能力
  - 支持本地模式与服务端模式，前者将API Key加密存储于浏览器，后者将API Key托管于后端
- 后端API（apps/api）
  - 基于NestJS，提供鉴权、项目/分镜/角色/世界观/系统提示词等资源管理
  - 通过Prisma连接PostgreSQL，使用BullMQ队列承载AI作业生命周期管理
- Worker（apps/worker）
  - 基于BullMQ Worker消费队列任务，执行各类AI生成与细化流程（场景锚点、关键帧、运动提示、对白、视频等）
  - 支持进度上报、协作式取消、自动重试与状态持久化

**章节来源**

- [apps/web/README.md](file://apps/web/README.md#L11-L72)
- [apps/api/src/app.module.ts](file://apps/api/src/app.module.ts#L16-L34)
- [apps/api/src/jobs/jobs.service.ts](file://apps/api/src/jobs/jobs.service.ts#L37-L43)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L44-L729)

## 架构总览

平台采用“前端-后端-任务执行”的分层架构，结合队列化工作流实现创作过程的自动化与可观测性。

```mermaid
graph TB
CLIENT["浏览器客户端<br/>apps/web"] --> API["API网关<br/>apps/api"]
API --> AUTH["鉴权模块"]
API --> RES["资源模块<br/>项目/分镜/角色/世界/系统提示"]
API --> QUEUE["队列服务<br/>BullMQ/Redis"]
API --> DB["数据库<br/>PostgreSQL/Prisma"]
QUEUE --> WORKER["Worker执行器<br/>apps/worker"]
WORKER --> AI["AI供应商适配层<br/>OpenAI/Gemini/Kimi/深思/豆包"]
WORKER --> DB
CLIENT -.-> SHARED["共享类型与Schema<br/>packages/shared"]
API -.-> SHARED
```

**图表来源**

- [apps/api/src/main.ts](file://apps/api/src/main.ts#L9-L26)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L44-L729)
- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L1-L8)

## 详细组件分析

### 前端编辑器（apps/web）

- 分镜生成与细化工作流
  - 通过工作流API触发后端队列任务，前端轮询进度并更新UI状态
  - 支持批量操作、版本历史、对比合并、模板系统、键盘快捷键等增强体验
- 数据与状态管理
  - 使用Zustand进行轻量级状态管理，结合LocalStorage持久化与版本迁移
  - 支持本地模式与服务端模式，API Key加密存储，避免浏览器直连供应商
- UI/UX与可访问性
  - 基于Shadcn/UI与Tailwind CSS，提供渐进式披露、响应式布局与暗色主题

```mermaid
sequenceDiagram
participant U as "用户"
participant W as "前端编辑器<br/>apps/web"
participant A as "后端API<br/>apps/api"
participant Q as "队列<br/>Redis/BullMQ"
participant K as "Worker<br/>apps/worker"
U->>W : 触发“生成分镜列表”
W->>A : 调用工作流接口
A->>Q : 入队AI作业
Q-->>K : 分配作业
K->>K : 执行AI生成/细化
K-->>A : 更新作业状态与结果
A-->>W : 返回作业状态
W-->>U : 展示进度与产物
```

**图表来源**

- [apps/web/src/components/editor/SceneGeneration.tsx](file://apps/web/src/components/editor/SceneGeneration.tsx#L128-L173)
- [apps/api/src/jobs/jobs.service.ts](file://apps/api/src/jobs/jobs.service.ts#L378-L418)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L145-L169)

**章节来源**

- [apps/web/README.md](file://apps/web/README.md#L11-L72)
- [apps/web/FINAL_REPORT.md](file://apps/web/FINAL_REPORT.md#L58-L200)
- [apps/web/IMPLEMENTATION_SUMMARY.md](file://apps/web/IMPLEMENTATION_SUMMARY.md#L11-L86)

### 后端API（apps/api）

- 鉴权与资源管理
  - JWT鉴权、用户/团队/成员模型、项目/分镜/角色/世界/系统提示词等资源CRUD
  - 严格的权限校验与资源存在性检查，防止越权与非法请求
- 队列化工作流
  - 通过BullMQ队列承载AI作业生命周期：入队、执行、重试、完成/失败/取消
  - 作业状态与进度持久化，前端可轮询查询
- 数据模型与状态机
  - 项目/剧集/分镜状态枚举，清晰表达创作流程的阶段推进与回退

```mermaid
classDiagram
class Project {
+String id
+String teamId
+String title
+ProjectWorkflowState workflowState
}
class Episode {
+String id
+String projectId
+Int order
+EpisodeWorkflowState workflowState
}
class Scene {
+String id
+String episodeId
+Int order
+SceneStatus status
}
class AIJob {
+String id
+AIJobStatus status
+String type
}
Project "1" --> "*" Episode : "包含"
Episode "1" --> "*" Scene : "包含"
Project "1" --> "*" AIJob : "作业"
Episode "1" --> "*" AIJob : "作业"
Scene "1" --> "*" AIJob : "作业"
```

**图表来源**

- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L116-L233)

**章节来源**

- [apps/api/src/app.module.ts](file://apps/api/src/app.module.ts#L16-L34)
- [apps/api/src/jobs/jobs.service.ts](file://apps/api/src/jobs/jobs.service.ts#L37-L100)
- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L16-L51)

### Worker（apps/worker）

- 任务执行与状态管理
  - 基于作业类型分发到具体任务处理器（场景锚点、关键帧、运动提示、对白、视频等）
  - 协作式取消：检测取消状态后抛错中止后续步骤，避免覆盖产物
  - 自动重试与进度提示，失败时保留作业状态以便前端感知
- 安全与可运维
  - 通过环境变量配置Redis连接、队列名与并发度
  - 优雅关闭与信号处理，保障任务执行的稳定性

```mermaid
flowchart TD
Start(["Worker启动"]) --> ParseEnv["解析环境变量"]
ParseEnv --> ConnectDB["连接数据库"]
ConnectDB --> ConnectQueue["连接Redis队列"]
ConnectQueue --> Listen["监听队列作业"]
Listen --> ExecTask{"根据作业类型执行"}
ExecTask --> UpdateRunning["更新作业状态为运行中"]
UpdateRunning --> Progress["上报进度/协作式取消检查"]
Progress --> Success{"执行成功？"}
Success --> |是| MarkSuccess["标记成功并写入结果"]
Success --> |否| Retry{"是否还有重试次数？"}
Retry --> |是| KeepQueued["保持排队并提示自动重试"]
Retry --> |否| MarkFailed["标记失败并记录错误"]
MarkSuccess --> Done(["结束"])
MarkSuccess --> Listen
KeepQueued --> Done
KeepQueued --> Listen
MarkFailed --> Done
MarkFailed --> Listen
```

**图表来源**

- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L44-L729)

**章节来源**

- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L44-L729)
- [apps/worker/ENVIRONMENT.md](file://apps/worker/ENVIRONMENT.md#L1-L25)

### 创作流程与工作流状态机

平台围绕“项目-剧集-分镜”的创作流程，定义了清晰的工作流状态机，覆盖从基础设定到导出的完整路径。

```mermaid
stateDiagram-v2
[*] --> IDLE
IDLE --> DATA_COLLECTING : "创建项目"
DATA_COLLECTING --> DATA_COLLECTED : "确认基础设定"
DATA_COLLECTED --> SCENE_LIST_GENERATING : "AI生成分镜列表"
SCENE_LIST_GENERATING --> SCENE_LIST_EDITING : "用户编辑分镜"
SCENE_LIST_EDITING --> SCENE_LIST_CONFIRMED : "确认分镜列表"
SCENE_LIST_CONFIRMED --> SCENE_PROCESSING : "分镜细化锚点/关键帧/运动/对白"
SCENE_PROCESSING --> ALL_SCENES_COMPLETE : "全部分镜完成"
ALL_SCENES_COMPLETE --> EXPORTING : "导出产物"
EXPORTING --> [*]
```

**图表来源**

- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L16-L32)
- [prd_backup.md](file://prd_backup.md#L1054-L1100)

**章节来源**

- [apps/api/prisma/schema.prisma](file://apps/api/prisma/schema.prisma#L16-L32)
- [prd_backup.md](file://prd_backup.md#L1054-L1100)

## 依赖分析

- 前端依赖
  - React 18.3、TypeScript 5.6、Vite 5、Shadcn/UI、Tailwind CSS、Zustand、@dnd-kit、recharts等
  - 通过懒加载与虚拟滚动优化渲染性能，分块存储与压缩优化本地存储
- 后端依赖
  - NestJS、Prisma、BullMQ、Fastify、JWT、CORS、Zod校验等
  - 通过模块化结构（Auth/Projects/Scenes/Characters/WorldView/AIProfiles/Jobs/SystemPrompts）实现高内聚低耦合
- Worker依赖
  - BullMQ、Prisma、Redis、AI供应商SDK（OpenAI/Gemini/Kimi/深思/豆包）

```mermaid
graph LR
WEB["apps/web"] --> REACT["React 18.3"]
WEB --> ZUSTAND["Zustand"]
WEB --> DNDKIT["@dnd-kit/*"]
WEB --> RECHARTS["recharts"]
API["apps/api"] --> NESTJS["NestJS"]
API --> PRISMA["Prisma"]
API --> BULLMQ["BullMQ"]
API --> FASTIFY["Fastify"]
WORKER["apps/worker"] --> BULLMQ
WORKER --> PRISMA
WORKER --> PROVIDERS["AI供应商SDK"]
```

**图表来源**

- [apps/web/README.md](file://apps/web/README.md#L73-L100)
- [apps/api/src/app.module.ts](file://apps/api/src/app.module.ts#L16-L34)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L1-L30)

**章节来源**

- [apps/web/README.md](file://apps/web/README.md#L73-L100)
- [apps/web/FINAL_REPORT.md](file://apps/web/FINAL_REPORT.md#L466-L498)
- [apps/worker/ENVIRONMENT.md](file://apps/worker/ENVIRONMENT.md#L1-L25)

## 性能考虑

- 前端性能
  - 分块存储与Gzip压缩，突破LocalStorage容量限制并降低占用
  - React.memo、虚拟滚动、防抖节流与懒加载，显著提升大项目渲染性能
  - 上下文压缩与流式响应处理，降低AI调用成本与延迟
- 后端性能
  - BullMQ队列化异步执行，避免阻塞请求；Prisma连接池与索引优化
  - 作业状态持久化与进度上报，前端可快速感知执行状态
- Worker性能
  - 并发度可控、锁时长与stalled检测，避免误判与资源浪费
  - 协作式取消与自动重试，兼顾可靠性与用户体验

**章节来源**

- [apps/web/FINAL_REPORT.md](file://apps/web/FINAL_REPORT.md#L525-L547)
- [apps/web/IMPLEMENTATION_SUMMARY.md](file://apps/web/IMPLEMENTATION_SUMMARY.md#L311-L327)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L721-L729)

## 故障排除指南

- 环境变量配置
  - API与Worker需分别配置数据库URL、Redis连接、队列名与API Key加密密钥
  - CORS与端口需与前端开发服务器匹配
- 队列与作业
  - 如出现“自动重试”提示，前端会保持等待；可在Worker日志中查看具体错误堆栈
  - 作业被取消时，Worker会协作式中止并避免覆盖产物
- 数据库迁移
  - 首次启动或迁移变更后，需执行数据库迁移命令；生产环境使用部署命令
- 前端模式切换
  - 本地模式将API Key加密存储于浏览器；服务端模式由后端托管API Key，前端不直接调用供应商接口

**章节来源**

- [apps/api/ENVIRONMENT.md](file://apps/api/ENVIRONMENT.md#L1-L31)
- [apps/worker/ENVIRONMENT.md](file://apps/worker/ENVIRONMENT.md#L1-L25)
- [apps/worker/src/worker.ts](file://apps/worker/src/worker.ts#L674-L719)
- [README.md](file://README.md#L35-L47)

## 结论

AIXSSS以“前端引导创作 + 后端编排 + Worker执行”的架构，构建了面向AIGC漫剧/短剧创作者的完整创作引导系统。平台在功能完整性、易用性、效率与安全性方面实现了显著提升，既能满足个人创作者的入门需求，也能支撑团队协作与规模化生产。通过持续的模块化演进与工程化实践，AIXSSS正逐步成为AIGC叙事创作领域的重要基础设施。

## 附录

- 快速开始与开发指南
  - 安装依赖、构建共享包、启动依赖服务、配置环境变量、数据库迁移、启动开发
- 本地数据迁移
  - API模式下可将浏览器本地项目导入云端，保留核心数据并支持后续扩展
- 许可证
  - 默认采用PolyForm Noncommercial 1.0.0，商业用途需另行授权

**章节来源**

- [README.md](file://README.md#L5-L61)
- [README.md](file://README.md#L75-L82)
- [README.md](file://README.md#L84-L92)
