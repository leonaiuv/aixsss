# 开发指南

<cite>
**本文档引用的文件**
- [manga-creator/package.json](file://manga-creator/package.json)
- [manga-creator/vite.config.ts](file://manga-creator/vite.config.ts)
- [manga-creator/tailwind.config.js](file://manga-creator/tailwind.config.js)
- [manga-creator/eslint.config.js](file://manga-creator/eslint.config.js)
- [manga-creator/src/main.tsx](file://manga-creator/src/main.tsx)
- [manga-creator/src/App.tsx](file://manga-creator/src/App.tsx)
- [manga-creator/src/stores/projectStore.ts](file://manga-creator/src/stores/projectStore.ts)
- [manga-creator/src/stores/configStore.ts](file://manga-creator/src/stores/configStore.ts)
- [manga-creator/src/hooks/use-toast.ts](file://manga-creator/src/hooks/use-toast.ts)
- [manga-creator/src/lib/ai/factory.ts](file://manga-creator/src/lib/ai/factory.ts)
- [manga-creator/src/lib/ai/skills.ts](file://manga-creator/src/lib/ai/skills.ts)
- [manga-creator/src/components/editor/SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx)
- [manga-creator/src/types/index.ts](file://manga-creator/src/types/index.ts)
- [manga-creator/src/lib/storage.ts](file://manga-creator/src/lib/storage.ts)
- [manga-creator/src/components/editor/SceneRefinement.test.tsx](file://manga-creator/src/components/editor/SceneRefinement.test.tsx)
- [manga-creator/src/hooks/use-toast.test.ts](file://manga-creator/src/hooks/use-toast.test.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [代码规范](#代码规范)
3. [测试策略](#测试策略)
4. [构建与工具](#构建与工具)
5. [自定义Hook开发](#自定义hook开发)

## 项目结构

本项目采用模块化目录结构，各目录职责明确，便于维护和扩展。

```mermaid
graph TD
A[src/] --> B[components/]
A --> C[stores/]
A --> D[lib/]
A --> E[hooks/]
A --> F[types/]
B --> G[ui/]
B --> H[editor/]
C --> I[projectStore.ts]
C --> J[configStore.ts]
D --> K[ai/]
D --> L[storage.ts]
D --> M[utils.ts]
E --> N[use-toast.ts]
K --> O[providers/]
K --> P[factory.ts]
K --> Q[skills.ts]
```

**Diagram sources**
- [manga-creator/package.json](file://manga-creator/package.json)
- [manga-creator/src/main.tsx](file://manga-creator/src/main.tsx)

**项目结构说明**

- **src/**: 项目源代码根目录
  - **components/**: 存放所有UI组件，包括通用UI组件和业务组件
  - **stores/**: Zustand状态管理存储，管理项目、配置等全局状态
  - **lib/**: 核心库和工具函数，包含AI服务集成、本地存储等
  - **hooks/**: 自定义React Hook，提供可复用的逻辑
  - **types/**: TypeScript类型定义，确保类型安全
  - **tests/**: 测试文件，包含测试配置和工具

**Section sources**
- [manga-creator/package.json](file://manga-creator/package.json)
- [manga-creator/src/main.tsx](file://manga-creator/src/main.tsx)

## 代码规范

### TypeScript类型使用

项目采用TypeScript进行类型安全开发，所有类型定义位于`src/types/index.ts`。关键类型包括：

- `Project`: 项目实体，包含项目基本信息和工作流状态
- `Scene`: 分镜实体，描述分镜的详细信息
- `UserConfig`: 用户AI配置，包含API密钥和模型信息
- `WorkflowState`: 工作流状态枚举，定义项目生命周期

类型使用遵循以下规范：
1. 所有组件props必须有明确的类型定义
2. API响应和数据结构必须使用接口定义
3. 枚举类型用于状态和选项，避免魔法字符串

```mermaid
classDiagram
class Project {
+id : string
+title : string
+summary : string
+style : string
+protagonist : string
+workflowState : WorkflowState
+currentSceneOrder : number
+createdAt : string
+updatedAt : string
}
class Scene {
+id : string
+projectId : string
+order : number
+summary : string
+sceneDescription : string
+actionDescription : string
+shotPrompt : string
+status : SceneStatus
+notes : string
}
class UserConfig {
+provider : ProviderType
+apiKey : string
+baseURL? : string
+model : string
}
Project "1" *-- "0..*" Scene
```

**Diagram sources**
- [manga-creator/src/types/index.ts](file://manga-creator/src/types/index.ts)

### React组件编写约定

React组件遵循以下约定：

1. **函数组件**: 所有组件使用函数组件和Hooks
2. **命名规范**: 组件文件名和组件名保持一致，使用PascalCase
3. **Props解构**: 在函数参数中解构props，提高可读性
4. **状态管理**: 使用Zustand进行全局状态管理，避免prop drilling

```mermaid
sequenceDiagram
participant App as App.tsx
participant Editor as Editor.tsx
participant SceneRefinement as SceneRefinement.tsx
participant Store as Zustand Store
App->>Store : 初始化状态
App->>Editor : 渲染编辑器
Editor->>SceneRefinement : 渲染分镜细化组件
SceneRefinement->>Store : 订阅项目和分镜状态
Store-->>SceneRefinement : 提供最新状态
SceneRefinement->>Store : 更新状态
```

**Diagram sources**
- [manga-creator/src/App.tsx](file://manga-creator/src/App.tsx)
- [manga-creator/src/components/editor/SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx)

### Zustand Store设计模式

Zustand存储采用创建模式，每个store负责特定领域的状态管理：

- `projectStore`: 管理项目列表和当前项目
- `configStore`: 管理AI配置和连接状态
- `storyboardStore`: 管理分镜数据和编辑状态

Store设计遵循以下原则：
1. **单一职责**: 每个store只管理特定领域的状态
2. **操作方法**: 提供清晰的API方法来更新状态
3. **副作用处理**: 在store中处理异步操作和副作用

```mermaid
classDiagram
class ProjectStore {
+projects : Project[]
+currentProject : Project | null
+isLoading : boolean
+loadProjects() : void
+loadProject(projectId : string) : void
+createProject(data : ProjectData) : Project
+updateProject(id : string, updates : Partial~Project~) : void
+deleteProject(id : string) : void
}
class ConfigStore {
+config : UserConfig | null
+isConfigured : boolean
+loadConfig() : void
+saveConfig(config : UserConfig) : void
+clearConfig() : void
+testConnection(config : UserConfig) : Promise~boolean~
}
ProjectStore --> ConfigStore : "依赖"
```

**Diagram sources**
- [manga-creator/src/stores/projectStore.ts](file://manga-creator/src/stores/projectStore.ts)
- [manga-creator/src/stores/configStore.ts](file://manga-creator/src/stores/configStore.ts)

### AI服务集成规范

AI服务集成采用工厂模式，通过`AIFactory`创建AI客户端，支持多种AI提供商：

```mermaid
classDiagram
class AIFactory {
+createClient(config : UserConfig) : AIClient
}
class AIClient {
-provider : AIProvider
-config : UserConfig
+providerName : string
+chat(messages : ChatMessage[]) : Promise~AIResponse~
+streamChat(messages : ChatMessage[]) : AsyncGenerator~string~
}
class AIProvider {
<<interface>>
+name : string
+chat(messages : ChatMessage[], config : UserConfig) : Promise~AIResponse~
+streamChat(messages : ChatMessage[], config : UserConfig) : AsyncGenerator~string~
}
class DeepSeekProvider {
+name : string
+chat() : Promise~AIResponse~
+streamChat() : AsyncGenerator~string~
}
class OpenAICompatibleProvider {
+name : string
+chat() : Promise~AIResponse~
+streamChat() : AsyncGenerator~string~
}
class GeminiProvider {
+name : string
+chat() : Promise~AIResponse~
+streamChat() : AsyncGenerator~string~
}
AIFactory --> AIClient : "创建"
AIClient --> AIProvider : "使用"
AIProvider <|-- DeepSeekProvider
AIProvider <|-- OpenAICompatibleProvider
AIProvider <|-- GeminiProvider
```

**Diagram sources**
- [manga-creator/src/lib/ai/factory.ts](file://manga-creator/src/lib/ai/factory.ts)
- [manga-creator/src/lib/ai/skills.ts](file://manga-creator/src/lib/ai/skills.ts)

AI服务集成的关键规范：
1. **工厂模式**: `AIFactory`根据配置创建相应的AI客户端
2. **适配器模式**: 每个AI提供商实现统一的`AIProvider`接口
3. **技能系统**: 通过`SkillRegistry`管理不同的AI任务技能
4. **错误处理**: 统一的错误处理机制，确保服务调用的可靠性

**Section sources**
- [manga-creator/src/lib/ai/factory.ts](file://manga-creator/src/lib/ai/factory.ts)
- [manga-creator/src/lib/ai/skills.ts](file://manga-creator/src/lib/ai/skills.ts)

## 测试策略

### 单元测试

单元测试使用Vitest框架，测试文件与源文件同目录存放，文件名以`.test.ts`或`.test.tsx`结尾。

**SceneRefinement组件测试**

`SceneRefinement.test.tsx`展示了完整的单元测试实践：

```mermaid
flowchart TD
A[测试设置] --> B[Mock依赖]
B --> C[渲染组件]
C --> D[模拟用户交互]
D --> E[断言结果]
E --> F[清理]
subgraph Mock依赖
B1[Mock projectStore]
B2[Mock storyboardStore]
B3[Mock configStore]
B4[Mock AIFactory]
B5[Mock skills]
end
subgraph 断言结果
E1[验证API调用次数]
E2[验证状态更新]
E3[验证UI变化]
E4[验证错误处理]
end
```

**Diagram sources**
- [manga-creator/src/components/editor/SceneRefinement.test.tsx](file://manga-creator/src/components/editor/SceneRefinement.test.tsx)

单元测试关键实践：
1. **依赖隔离**: 使用`vi.mock()`隔离外部依赖
2. **状态模拟**: 模拟store状态和更新函数
3. **异步处理**: 使用`waitFor`和`act`处理异步操作
4. **边界情况**: 测试重复点击、错误处理等边界情况

### 集成测试

集成测试确保多个组件协同工作正常。测试重点包括：

1. **状态流**: 验证状态在组件间的正确传递
2. **副作用**: 验证异步操作和副作用的正确执行
3. **用户流程**: 验证完整的用户交互流程

**Section sources**
- [manga-creator/src/components/editor/SceneRefinement.test.tsx](file://manga-creator/src/components/editor/SceneRefinement.test.tsx)
- [manga-creator/src/hooks/use-toast.test.ts](file://manga-creator/src/hooks/use-toast.test.ts)

## 构建与工具

### 构建工具（Vite）

项目使用Vite作为构建工具，配置文件为`vite.config.ts`。

```mermaid
flowchart LR
A[源代码] --> B[Vite]
B --> C[开发服务器]
B --> D[生产构建]
subgraph 开发服务器
C1[热模块替换]
C2[快速启动]
C3[代理配置]
end
subgraph 生产构建
D1[TypeScript编译]
D2[代码分割]
D3[资源优化]
D4[代码压缩]
end
```

**Diagram sources**
- [manga-creator/vite.config.ts](file://manga-creator/vite.config.ts)

Vite配置关键特性：
1. **别名配置**: `@`指向`src/`目录，简化导入路径
2. **测试配置**: 配置Vitest的测试环境和覆盖率报告
3. **开发服务器**: 配置host和端口，支持外部访问

### 样式框架（Tailwind CSS）

项目使用Tailwind CSS进行样式开发，配置文件为`tailwind.config.js`。

样式开发遵循以下规范：
1. **原子化CSS**: 使用Tailwind的原子类进行样式编写
2. **主题定制**: 在配置中定义颜色、半径等设计系统
3. **响应式设计**: 使用Tailwind的响应式前缀实现响应式布局

### 代码质量工具（ESLint）

ESLint配置确保代码质量和一致性，主要规则包括：
1. **TypeScript推荐规则**: 遵循TypeScript的最佳实践
2. **React Hooks规则**: 确保Hooks的正确使用
3. **代码风格**: 统一的代码格式和风格

**Section sources**
- [manga-creator/vite.config.ts](file://manga-creator/vite.config.ts)
- [manga-creator/tailwind.config.js](file://manga-creator/tailwind.config.js)
- [manga-creator/eslint.config.js](file://manga-creator/eslint.config.js)

## 自定义Hook开发

### use-toast开发指导

`use-toast.ts`展示了自定义Hook的高级开发模式，采用Redux风格的状态管理。

```mermaid
flowchart TD
A[useToast Hook] --> B[状态管理]
A --> C[副作用处理]
A --> D[API暴露]
subgraph 状态管理
B1[reducer函数]
B2[dispatch函数]
B3[状态订阅]
end
subgraph 副作用处理
C1[定时器管理]
C2[内存泄漏防护]
C3[事件监听]
end
subgraph API暴露
D1[toast函数]
D2[dismiss函数]
D3[update函数]
end
```

**Diagram sources**
- [manga-creator/src/hooks/use-toast.ts](file://manga-creator/src/hooks/use-toast.ts)

自定义Hook开发最佳实践：
1. **状态封装**: 将复杂的状态逻辑封装在Hook中
2. **内存安全**: 正确处理组件卸载时的清理工作
3. **性能优化**: 使用`useCallback`和`useMemo`避免不必要的重新渲染
4. **类型安全**: 提供完整的TypeScript类型定义

**Section sources**
- [manga-creator/src/hooks/use-toast.ts](file://manga-creator/src/hooks/use-toast.ts)