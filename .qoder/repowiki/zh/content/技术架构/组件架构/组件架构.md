# 组件架构

<cite>
**本文档引用的文件**  
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)
- [ProjectCard.tsx](file://manga-creator/src/components/ProjectCard.tsx)
- [projectStore.ts](file://manga-creator/src/stores/projectStore.ts)
- [configStore.ts](file://manga-creator/src/stores/configStore.ts)
- [storyboardStore.ts](file://manga-creator/src/stores/storyboardStore.ts)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx)
- [SceneGeneration.tsx](file://manga-creator/src/components/editor/SceneGeneration.tsx)
- [SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx)
- [button.tsx](file://manga-creator/src/components/ui/button.tsx)
- [card.tsx](file://manga-creator/src/components/ui/card.tsx)
- [storage.ts](file://manga-creator/src/lib/storage.ts)
- [index.ts](file://manga-creator/src/types/index.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [状态管理](#状态管理)
4. [组件树结构](#组件树结构)
5. [渲染流程时序](#渲染流程时序)
6. [UI组件库集成](#ui组件库集成)
7. [事件传递机制](#事件传递机制)
8. [多步骤创作流程](#多步骤创作流程)
9. [结论](#结论)

## 项目结构

本项目采用基于React 18.3的前端架构，使用Vite作为构建工具。项目结构清晰，遵循功能模块化组织原则，主要分为components（组件）、stores（状态管理）、lib（工具库）、types（类型定义）等核心目录。

```mermaid
graph TD
A[manga-creator] --> B[src]
B --> C[components]
C --> D[editor]
C --> E[ui]
C --> F[ProjectCard]
C --> G[ProjectList]
C --> H[Editor]
C --> I[ConfigDialog]
B --> J[stores]
J --> K[projectStore]
J --> L[configStore]
J --> M[storyboardStore]
B --> N[lib]
N --> O[ai]
N --> P[storage]
N --> Q[utils]
B --> R[types]
B --> S[App.tsx]
B --> T[main.tsx]
```

**图示来源**
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)

**本节来源**
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)

## 核心组件

本系统的核心组件体系由App根组件协调，主要包含ProjectList和Editor两大视图组件。App组件作为应用的根组件，负责初始化状态、协调视图切换和全局UI元素的渲染。

ProjectList组件负责项目列表的展示与管理，通过ProjectCard组件实现单个项目卡片的渲染。Editor组件则提供多步骤的创作流程界面，包含基础设定、分镜生成、分镜细化等子组件。

```mermaid
classDiagram
class App {
+currentView : 'list' | 'editor'
+configDialogOpen : boolean
+useEffect() : void
}
class ProjectList {
+createDialogOpen : boolean
+deleteDialogOpen : boolean
+projectToDelete : string | null
+newProjectTitle : string
+handleCreate() : void
+handleOpenProject() : void
+handleDeleteClick() : void
+handleDeleteConfirm() : void
}
class Editor {
+activeStep : 'basic' | 'generation' | 'refinement' | 'export'
+steps : EditorStep[]
+getStepStatus() : string
+handleStepClick() : void
}
App --> ProjectList : "渲染"
App --> Editor : "渲染"
ProjectList --> ProjectCard : "包含"
Editor --> BasicSettings : "包含"
Editor --> SceneGeneration : "包含"
Editor --> SceneRefinement : "包含"
Editor --> PromptExport : "包含"
```

**图示来源**
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)
- [ProjectCard.tsx](file://manga-creator/src/components/ProjectCard.tsx)

**本节来源**
- [App.tsx](file://manga-creator/src/App.tsx#L1-L81)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx#L1-L172)

## 状态管理

系统采用Zustand作为状态管理方案，通过多个store实现状态的集中管理和注入。projectStore负责管理项目相关的状态和操作，包括项目列表、当前项目、创建、更新和删除项目等。

```mermaid
classDiagram
class projectStore {
+projects : Project[]
+currentProject : Project | null
+isLoading : boolean
+loadProjects() : void
+loadProject() : void
+createProject() : Project
+updateProject() : void
+deleteProject() : void
+setCurrentProject() : void
}
class configStore {
+config : UserConfig | null
+isConfigured : boolean
+loadConfig() : void
+saveConfig() : void
+clearConfig() : void
+testConnection() : Promise~boolean~
}
class storyboardStore {
+scenes : Scene[]
+currentSceneId : string | null
+isGenerating : boolean
+loadScenes() : void
+setScenes() : void
+addScene() : Scene
+updateScene() : void
+deleteScene() : void
+reorderScenes() : void
+setCurrentScene() : void
+setGenerating() : void
}
App --> projectStore : "使用"
App --> configStore : "使用"
ProjectList --> projectStore : "使用"
Editor --> projectStore : "使用"
Editor --> storyboardStore : "使用"
SceneGeneration --> storyboardStore : "使用"
SceneRefinement --> storyboardStore : "使用"
```

**图示来源**
- [projectStore.ts](file://manga-creator/src/stores/projectStore.ts)
- [configStore.ts](file://manga-creator/src/stores/configStore.ts)
- [storyboardStore.ts](file://manga-creator/src/stores/storyboardStore.ts)

**本节来源**
- [projectStore.ts](file://manga-creator/src/stores/projectStore.ts#L1-L95)
- [configStore.ts](file://manga-creator/src/stores/configStore.ts#L1-L58)
- [storyboardStore.ts](file://manga-creator/src/stores/storyboardStore.ts#L1-L107)

## 组件树结构

系统的组件树结构清晰地展示了UI层级关系。App组件作为根节点，根据currentView状态决定渲染ProjectList或Editor组件。这种设计实现了视图的动态切换，同时保持了应用状态的连续性。

```mermaid
graph TD
A[App] --> B[Header]
A --> C[Main]
C --> D{currentView}
D --> |list| E[ProjectList]
D --> |editor| F[Editor]
E --> G[ProjectCard]
E --> H[CreateDialog]
E --> I[DeleteDialog]
F --> J[EditorNav]
F --> K[EditorContent]
K --> L[BasicSettings]
K --> M[SceneGeneration]
K --> N[SceneRefinement]
K --> O[PromptExport]
A --> P[ConfigDialog]
A --> Q[Toaster]
style A fill:#4A90E2,stroke:#333
style E fill:#50C878,stroke:#333
style F fill:#FF6B6B,stroke:#333
style G fill:#9B59B6,stroke:#333
style L fill:#F39C12,stroke:#333
style M fill:#F39C12,stroke:#333
style N fill:#F39C12,stroke:#333
```

**图示来源**
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)
- [ProjectCard.tsx](file://manga-creator/src/components/ProjectCard.tsx)

**本节来源**
- [App.tsx](file://manga-creator/src/App.tsx#L1-L81)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx#L1-L172)

## 渲染流程时序

系统的渲染流程时序展示了组件的生命周期和状态变化过程。从应用初始化到视图切换，再到具体功能操作，整个流程通过状态驱动和事件响应机制实现。

```mermaid
sequenceDiagram
participant App as App组件
participant ProjectList as ProjectList组件
participant Editor as Editor组件
participant Store as Zustand Store
App->>Store : useEffect初始化
Store->>Store : initStorage()
Store->>Store : loadProjects()
Store->>Store : loadConfig()
Store-->>App : 状态加载完成
ProjectList->>Store : createProject()
Store->>Store : 保存项目到localStorage
Store-->>ProjectList : 更新projects状态
ProjectList->>App : onOpenEditor()
App->>App : setCurrentView('editor')
Editor->>Store : 监听workflowState变化
Store->>Editor : workflowState更新
Editor->>Editor : 自动切换activeStep
Editor->>window : dispatchEvent('workflow : next-step')
window->>Editor : 监听到事件
Editor->>Editor : 切换到下一步
```

**图示来源**
- [App.tsx](file://manga-creator/src/App.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)
- [projectStore.ts](file://manga-creator/src/stores/projectStore.ts)

**本节来源**
- [App.tsx](file://manga-creator/src/App.tsx#L1-L81)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx#L1-L172)

## UI组件库集成

系统集成了基于Shadcn/ui的UI组件库，实现了原子化组件的复用。Button、Card、Dialog等基础组件在业务界面中被广泛使用，确保了UI风格的一致性和开发效率。

```mermaid
classDiagram
class Button {
+variant : 'default' | 'destructive' | 'outline' | 'secondary' | 'ghost' | 'link'
+size : 'default' | 'sm' | 'lg' | 'icon'
+asChild : boolean
+className : string
}
class Card {
+CardHeader
+CardTitle
+CardDescription
+CardContent
+CardFooter
}
class Dialog {
+DialogContent
+DialogHeader
+DialogTitle
+DialogDescription
+DialogFooter
}
class AlertDialog {
+AlertDialogContent
+AlertDialogHeader
+AlertDialogTitle
+AlertDialogDescription
+AlertDialogFooter
+AlertDialogAction
+AlertDialogCancel
}
ProjectList --> Button : "使用"
ProjectList --> Card : "使用"
ProjectList --> Dialog : "使用"
ProjectList --> AlertDialog : "使用"
Editor --> Button : "使用"
Editor --> Card : "使用"
BasicSettings --> Button : "使用"
BasicSettings --> Card : "使用"
SceneGeneration --> Button : "使用"
SceneGeneration --> Card : "使用"
SceneRefinement --> Button : "使用"
SceneRefinement --> Card : "使用"
```

**图示来源**
- [button.tsx](file://manga-creator/src/components/ui/button.tsx)
- [card.tsx](file://manga-creator/src/components/ui/card.tsx)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx)
- [SceneGeneration.tsx](file://manga-creator/src/components/editor/SceneGeneration.tsx)
- [SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx)

**本节来源**
- [button.tsx](file://manga-creator/src/components/ui/button.tsx#L1-L58)
- [card.tsx](file://manga-creator/src/components/ui/card.tsx#L1-L77)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)

## 事件传递机制

系统的事件传递机制通过props回调函数实现父子组件间的通信。ProjectList组件通过onOpenEditor回调通知App组件切换视图，通过onOpen和onDelete回调传递给ProjectCard组件，实现打开和删除项目的交互行为。

```mermaid
flowchart TD
A[ProjectCard] --> |onDelete| B[ProjectList]
B --> |handleDeleteClick| C[setDeleteDialogOpen]
C --> D[显示删除确认对话框]
D --> |确认| E[deleteProject]
E --> F[更新store状态]
F --> G[刷新UI]
A --> |onOpen| B
B --> |handleOpenProject| H[setCurrentProject]
H --> I[更新store状态]
I --> J[onOpenEditor]
J --> K[App切换视图]
K --> L[渲染Editor组件]
M[BasicSettings] --> |handleProceed| N[dispatchEvent]
N --> O[Editor监听事件]
O --> P[切换activeStep]
P --> Q[渲染下一步组件]
```

**图示来源**
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx)
- [ProjectCard.tsx](file://manga-creator/src/components/ProjectCard.tsx)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)

**本节来源**
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)
- [ProjectCard.tsx](file://manga-creator/src/components/ProjectCard.tsx#L1-L110)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx#L1-L224)

## 多步骤创作流程

Editor组件实现了多步骤的创作流程，通过工作流状态机管理创作进度。系统定义了多个创作步骤（基础设定、分镜生成、分镜细化、提示词导出），每个步骤对应不同的子组件和UI界面。

```mermaid
stateDiagram-v2
[*] --> IDLE
IDLE --> DATA_COLLECTING : 创建项目
DATA_COLLECTING --> DATA_COLLECTED : 完成基础设定
DATA_COLLECTED --> SCENE_LIST_GENERATING : 开始生成分镜
SCENE_LIST_GENERATING --> SCENE_LIST_EDITING : 生成完成
SCENE_LIST_EDITING --> SCENE_LIST_CONFIRMED : 确认分镜列表
SCENE_LIST_CONFIRMED --> SCENE_PROCESSING : 开始分镜细化
SCENE_PROCESSING --> ALL_SCENES_COMPLETE : 完成所有分镜
ALL_SCENES_COMPLETE --> EXPORTING : 开始导出
EXPORTING --> IDLE : 导出完成
classDef active fill : #4A90E2,stroke : #333,color : #fff
classDef completed fill : #50C878,stroke : #333,color : #fff
classDef pending fill : #D3D3D3,stroke : #333,color : #333
class DATA_COLLECTED,SCENE_LIST_EDITING,SCENE_PROCESSING,ALL_SCENES_COMPLETE active
```

**图示来源**
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx)
- [SceneGeneration.tsx](file://manga-creator/src/components/editor/SceneGeneration.tsx)
- [SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx)
- [index.ts](file://manga-creator/src/types/index.ts)

**本节来源**
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx#L1-L172)
- [BasicSettings.tsx](file://manga-creator/src/components/editor/BasicSettings.tsx#L1-L224)
- [SceneGeneration.tsx](file://manga-creator/src/components/editor/SceneGeneration.tsx#L1-L383)
- [SceneRefinement.tsx](file://manga-creator/src/components/editor/SceneRefinement.tsx#L1-L638)

## 结论

本系统构建了一个基于React 18.3的完整前端组件体系，通过App根组件协调ProjectList和Editor两大核心视图。系统采用Zustand进行状态管理，实现了项目状态的集中管理和跨组件共享。

组件架构清晰，层次分明，通过props回调和自定义事件实现了组件间的通信。UI组件库的集成确保了界面风格的一致性和开发效率。多步骤创作流程通过工作流状态机实现，提供了流畅的用户体验。

系统的可扩展性强，通过模块化的设计，可以方便地添加新的功能组件和状态管理逻辑。整体架构遵循现代前端开发的最佳实践，为后续的功能迭代和维护提供了坚实的基础。

**本节来源**
- [App.tsx](file://manga-creator/src/App.tsx#L1-L81)
- [ProjectList.tsx](file://manga-creator/src/components/ProjectList.tsx#L1-L196)
- [Editor.tsx](file://manga-creator/src/components/Editor.tsx#L1-L172)
- [projectStore.ts](file://manga-creator/src/stores/projectStore.ts#L1-L95)